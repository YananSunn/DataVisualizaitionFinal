<html>
<head>
    <meta charset="utf-8">
    <title>全国天气质量可视化</title>
    <script src="d3.min.js"></script>
    <script src="d3-v6-tip.js"></script>
    <link rel="stylesheet" href="d3-tip.css">
    <link rel="stylesheet" type="text/css" href="http://unpkg.com/view-design/dist/styles/iview.css">
    <script type="text/javascript" src="http://vuejs.org/js/vue.min.js"></script>
    <script type="text/javascript" src="http://unpkg.com/view-design/dist/iview.min.js"></script>
    <script src="ra2.js"></script>
    <script src="RadarChart.js"></script>
</head>
<body>
<div id="app">
    <i-menu mode="horizontal" :theme="theme1" active-name="1" @on-select="ChangeMenu">
        <Menu-Item name="1">
            <Icon type="ios-paper"></Icon>
            全国空气质量数据
        </Menu-Item>
        <Menu-Item name="2">
            <Icon type="ios-timer"></Icon>
            城市历史空气质量数据
        </Menu-Item>
        <Menu-Item name="3" v-on:click=>
            <Icon type="ios-people"></Icon>
            城市空气质量排名
        </Menu-Item>
        <Menu-Item name="4">
            <Icon type="ios-stats"></Icon>
            地区AQI排名
        </Menu-Item>
        <Menu-Item name="5">
            <Icon type="ios-map"></Icon>
            地域分布
        </Menu-Item>
    </i-menu>
    <div id="content1" v-show="menuId == '1'">
        <div class="cardBox">
            <div class="cardDiv">
                <Card class="timeSelection" >
                    <p slot="title">
                        <Icon type="ios-warning-outline"></Icon>
                        注意事项
                    </p>
                    <ul>
                        <div>
                            <p>可查询时间范围为 2014年5月14日 至 2021年4月19日。</p>
                            <br>
                        </div>
                    </ul>
                </Card>
            </div>
            <div class="cardDiv">
                <Card class="timeSelection" >
                    <p slot="title">
                        <Icon type="ios-apps-outline"></Icon>
                        选择查询指标
                    </p>
                    <ul>
                        <div>
                            <i-select v-model="selectTarget" placeholder="请选择指标" style="width:200px">
                                <i-option v-for="item in targetList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                            </i-select>
                            
                            <!-- <i-button @click="SubmitDate">展示</i-button>
                            <Modal v-model="invalidDate" title="警告">您输入了不合法的日期，请重试</Modal>
                            <Modal v-model="undefinedDate" title="警告">您未选择确定的日期</Modal> -->
                        </div>
                    </ul>
                </Card>
            </div>
            <div class="cardDiv2">
                <Card class="timeSelection" >
                    <p slot="title">
                        <Icon type="ios-calendar-outline"></Icon>
                        选择查询日期
                    </p>
                    <ul>
                        <div>
                            <p>您当前查询的时间为 <b>{{queryTime}}</b>。</p>
                            <br>
                            <i-select v-model="selectYear" placeholder="请选择年" clearable style="width:200px">
                                <i-option v-for="item in yearList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                            </i-select>
                            <i-select v-model="selectMonth" placeholder="请选择月" clearable style="width:200px">
                                <i-option v-for="item in monthList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                            </i-select>
                            <i-select v-model="selectDay" placeholder="请选择日" clearable style="width:200px">
                                <i-option v-for="item in dayList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                            </i-select>
                            <i-button @click="SubmitDate">展示</i-button>
                            <Modal v-model="invalidDate" title="警告">您输入了不合法的日期，请重试</Modal>
                            <Modal v-model="undefinedDate" title="警告">您未选择确定的日期</Modal>
                        </div>
                    </ul>
                </Card>
            </div>
        </div>
        <svg width="1000" height="700" id="mapSvg" class="svgs" style='display: block;'></svg>
        <i-button id="closeRadar" type="info" shape="circle" size="middle" v-show="closeRadar" @click="CloseRadarPlot">
            <p>关闭雷达图</p>
        </i-button>
    </div>
    <div id="content2" v-show="menuId == '2'">
        <div class="cardBox">
            <div class="cardDiv">
                <Card class="plotSelection" >
                    <p slot="title">
                        <Icon type="ios-information-circle-outline"></Icon>
                        提示
                    </p>
                    <ul>
                        <div>
                            <p>当前显示的城市为<b>{{selectCity}}</b>。</p>
                            <br>
                        </div>
                    </ul>
                </Card>
            </div>
            <div class="cardDiv">
                <Card class="plotSelection" >
                    <p slot="title">
                        <Icon type="ios-browsers-outline"></Icon>
                        选择展示的图
                    </p>
                    <ul>
                        <div>
                            <Radio-Group v-model="selectPlot" @on-change="ChangePlot">
                                <Radio label="散点图/折线图"></Radio>
                                <Radio label="箱线图"></Radio>
                            </Radio-Group>
                        </div>
                    </ul>
                </Card>
            </div>
            <div class="cardDiv" v-show="showScaleCard">
                <Card class="plotSelection" >
                    <p slot="title">
                        <Icon type="ios-crop-outline"></Icon>
                        选择散点图的展示规模
                    </p>
                    <ul>
                        <div>
                            <Radio-Group v-model="selectScale" @on-change="ChangePlot">
                                <Radio label="全局"></Radio>
                                <Radio label="局部"></Radio>
                            </Radio-Group>
                        </div>
                    </ul>
                </Card>
            </div>
         </div>
        
        <div id="plots">
            <div id="plotAQI">
                <svg class="plotSvg" width="1200" height="300" id="plotAQISvg" class="svgs"></svg>
                <i-button class="backButton" type="info" shape="circle" size="middle" v-show="dateBack0" @click="DateGoBack(0)">
                    <p>返回</p>
                </i-button>
                <i-button class="backButton" type="info" shape="circle" size="middle" v-show="boxDateBack0" @click="BoxDateGoBack(0)">
                    <p>返回</p>
                </i-button>
            </div>
            <div id="plotPM25">
                <svg class="plotSvg" width="1200" height="300" id="plotPM25Svg" class="svgs"></svg>
                <i-button class="backButton" type="info" shape="circle" size="middle" v-show="dateBack1" @click="DateGoBack(1)">
                    <p>返回</p>
                </i-button>
                <i-button class="backButton" type="info" shape="circle" size="middle" v-show="boxDateBack1" @click="BoxDateGoBack(1)">
                    <p>返回</p>
                </i-button>
            </div>
            <div id="plotPM10">
                <svg class="plotSvg" width="1200" height="300" id="plotPM10Svg" class="svgs"></svg>
                <i-button class="backButton" type="info" shape="circle" size="middle" v-show="dateBack2" @click="DateGoBack(2)">
                    <p>返回</p>
                </i-button>
                <i-button class="backButton" type="info" shape="circle" size="middle" v-show="boxDateBack2" @click="BoxDateGoBack(2)">
                    <p>返回</p>
                </i-button>
            </div>
            <div id="plotSO2">
                <svg class="plotSvg" width="1200" height="300" id="plotSO2Svg" class="svgs"></svg>
                <i-button class="backButton" type="info" shape="circle" size="middle" v-show="dateBack3" @click="DateGoBack(3)">
                    <p>返回</p>
                </i-button>
                <i-button class="backButton" type="info" shape="circle" size="middle" v-show="boxDateBack3" @click="BoxDateGoBack(3)">
                    <p>返回</p>
                </i-button>
            </div>
            <div id="plotO3">
                <svg class="plotSvg" width="1200" height="300" id="plotO3Svg" class="svgs"></svg>
                <i-button class="backButton" type="info" shape="circle" size="middle" v-show="dateBack4" @click="DateGoBack(4)">
                    <p>返回</p>
                </i-button>
                <i-button class="backButton" type="info" shape="circle" size="middle" v-show="boxDateBack4" @click="BoxDateGoBack(4)">
                    <p>返回</p>
                </i-button>
            </div>
            <div id="plotCO">
                <svg class="plotSvg" width="1200" height="300" id="plotCOSvg" class="svgs"></svg>
                <i-button class="backButton" type="info" shape="circle" size="middle" v-show="dateBack5" @click="DateGoBack(5)">
                    <p>返回</p>
                </i-button>
                <i-button class="backButton" type="info" shape="circle" size="middle" v-show="boxDateBack5" @click="BoxDateGoBack(5)">
                    <p>返回</p>
                </i-button>
            </div>
        </div>
    </div>
    <div v-show="menuId == '3'">
        <div class="cardBox">
            <div class="cardDiv">
                <Card class="rankSelection" >
                    <p slot="title">
                        <Icon type="ios-stats-outline"></Icon>
                        选择排名指标
                    </p>
                    <ul>
                        <div>
                            <Radio-Group v-model="qualityRank" @on-change="ChangeQualityRank">
                                <Radio label="AQI最好"></Radio>
                                <Radio label="AQI最差"></Radio>
                            </Radio-Group>
                        </div>
                    </ul>
                </Card>
            </div>
        </div>
        <svg width="1400" height="700" id="rankSvg" class="svgs"></svg>
    </div>
    <div v-show="menuId == '4'">
        <div class="cardBox">
            <div class="cardDiv">
                <Card class="regionSelection" >
                    <p slot="title">
                        <Icon type="ios-map-outline"></Icon>
                        选择排名地区
                    </p>
                    <ul>
                        <div>
                            <i-select v-model="selectRegion" placeholder="请选择地区" clearable @on-change="ChangeRegion" style="width:200px">
                                <i-option v-for="item in regionList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                            </i-select>
                        </div>
                    </ul>
                </Card>
            </div>
        </div>
        <svg width="1400" height="700" id="rankSvgLoc" class="svgs"></svg>
    </div>
    <div v-show="menuId == '5'">
        <div class="cardBox">
            <div class="cardDiv">
                <Card class="distributionSelection" >
                    <p slot="title">
                        <Icon type="ios-stats-outline"></Icon>
                        选择查看分布的指标
                    </p>
                    <ul>
                        <div>
                            <Radio-Group v-model="qualityDistribution" @on-change="ChangeQualityDistribution">
                                <Radio label="AQI最好"></Radio>
                                <Radio label="AQI最差"></Radio>
                            </Radio-Group>
                        </div>
                    </ul>
                </Card>
            </div>
        </div>
        
    </div>    
    
</div>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            theme1: 'light',
            menuId: '1',

            selectYear: '',
            yearList: [],
            selectMonth: '',
            monthList: [],
            selectDay: '',
            dayList: [],

            timeRange: '',

            invalidDate: false,
            undefinedDate: false,
            closeRadar: false,

            queryTime: "xxx",

            selectTarget: 'AQI',
            targetList: [
                {
                    value: 'AQI',
                    label: 'AQI'
                },
                {
                    value: 'PM2.5',
                    label: 'PM2.5'
                },
                {
                    value: 'PM10',
                    label: 'PM10'
                },
                {
                    value: 'SO2',
                    label: 'SO2'
                },
                {
                    value: 'O3',
                    label: 'O3'
                },
                {
                    value: 'CO',
                    label: 'CO'
                }
            ],

            selectPlot: '散点图/折线图',
            selectScale: '全局',
            selectCity: '北京',
            showScaleCard: true,

            dateBack0: false,
            dateBack1: false,
            dateBack2: false,
            dateBack3: false,
            dateBack4: false,
            dateBack5: false,

            boxDateBack0: false,
            boxDateBack1: false,
            boxDateBack2: false,
            boxDateBack3: false,
            boxDateBack4: false,
            boxDateBack5: false,

            AQIDayMean: [],
            PM25DayMean: [],
            PM10DayMean: [],
            SO2DayMean: [],
            O3DayMean: [],
            CODayMean: [],
            
            qualityRank: 'AQI最好',

            selectRegion: '',
            regionList:[
                {
                    value: '华中',
                    label: '华中'
                },
                {
                    value: '华北',
                    label: '华北'
                },
                {
                    value: '华东',
                    label: '华东'
                },
                {
                    value: '华南',
                    label: '华南'
                },
                {
                    value: '西北',
                    label: '西北'
                },
                {
                    value: '东北',
                    label: '东北'
                },
                {
                    value: '西南',
                    label: '西南'
                }
            ],

            qualityDistribution: 'AQI最好',

            projection: d3.geoMercator()
        },
        beforeMount () {
            console.log('==============' + 'beforeMount' + '===================')
            for(var i = 2014; i < 2022; i++){
                this.yearList.push({
                    value: i,
                    label: i.toString() + "年"
                })
            }
            // console.log(this.yearList)

            for(var i = 1; i < 13; i++){
                this.monthList.push({
                    value: i,
                    label: i.toString() + "月",
                })
            }
            // console.log(this.monthList)

            for(var i = 1; i < 32; i++){
                this.dayList.push({
                    value: i,
                    label: i.toString() + "日"
                })
            }
            // console.log(this.dayList)

            for(var i = 1400025600000; i <= 1618790400000; i = i + 86400000){
                this.AQIDayMean.push({
                    date: new Date(i),
                    value: 0
                })
                this.PM25DayMean.push({
                    date: new Date(i),
                    value: 0
                })
                this.PM10DayMean.push({
                    date: new Date(i),
                    value: 0
                })
                this.SO2DayMean.push({
                    date: new Date(i),
                    value: 0
                })
                this.O3DayMean.push({
                    date: new Date(i),
                    value: 0
                })
                this.CODayMean.push({
                    date: new Date(i),
                    value: 0
                })
            }
        },
        mounted () {
            console.log('==============' + 'mounted' + '===================')
            RenderMap()
        },
        methods: {
            // show: function () {
            //     this.visible = true;
            // }
            handleSpinCustom () {
                this.$Spin.show({
                    render: (h) => {
                        return h('div', [
                            h('Icon', {
                                'class': 'demo-spin-icon-load',
                                props: {
                                    type: 'ios-loading',
                                    size: 18
                                }
                            }),
                            h('div', '正在加载，请稍后......')
                        ])
                    }
                });
                setTimeout(() => {
                    this.$Spin.hide();
                }, 3000);
            }
        }
    })

    const circleRadius = 7
    var zoomScale = 1
    var myTarget
    var myTime = ''
    var myYear
    var myMonth
    var myDay
    var highlightedYear = [];
    var highlightedMonth = [];

    const mapColors = d3.scaleOrdinal(d3.schemeBlues[9])

    /**
     * change the open menu item and control badge to remind the new messages
     * @name ChangeMenu
     * @param name<string>:the name of the selected submenu
     * @return null
     */
     function ChangeMenu(name) {
      app.menuId = name;
      if(name == '2'){
        ReadHistoryData()
        ChangePlot()
        app.handleSpinCustom()
      }
      if(name == '3'){
        DrawRating('#rankSvg', 'AQI_seasonmean_D3.csv', app.qualityRank)
      }
    }

    function DrawRating(divid, filename, good){
        const svg = d3.select(divid);
        svg.selectAll('.ratingg').remove()
        const width = svg.attr('width');
        const height = svg.attr('height');
        const margin = {top: 100, right: 180, bottom: 100, left: 180};
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        const mainGroup = svg.append('g')
        .attr('class', 'ratingg')
        .attr('transform', `translate(${margin.left}, ${margin.top})`)

        const xValue = d => d.AQI;
        const yValue = d => d.City;
        const keyValue = d => d.Season;
        const xScale = d3.scaleLinear();
        const yScale = d3.scaleBand();
        const colorScale = d3.scaleOrdinal();
        const xAxisMethod = d3.axisBottom(xScale);
        const yAxisMethod = d3.axisLeft(yScale);  
        const xAxisGroup = mainGroup.append('g')
            .attr('transform', `translate(${0}, ${innerHeight})`)
            .attr('id', 'xaxis');
        const yAxisGroup = mainGroup.append('g')
            .attr('id', 'yaxis');

        const xAxisLabel ='AQI';
        const yAxisLabel = 'City';

        const aduration = 4000;

        var formatPercent = d3.format(".2f");


        const render_init = function (data) {
          //添加x轴标签
          xAxisGroup.append('text')
          .attr('class', 'axisname')
          .attr('font-size', '2em')
          .attr('y', 60)
          .attr('x', innerWidth / 2)
          .attr('fill', '#333333')
          .text(xAxisLabel)

          //添加y轴标签
          yAxisGroup.append('text')
          .attr('class', 'axisname')
          .attr('font-size', '2em')
          .attr('transform', `rotate(-90)`)
          .attr('x', -innerHeight / 2)
          .attr('y', -60)
          .attr('fill', '#333333')
          .text(yAxisLabel)
          .attr('text-anchor', 'middle');

          //年份
          mainGroup.append("text")
          .attr('id', 'year')
          .attr('class', 'year_text')
          .attr("x", innerWidth + 10)
          .attr("y", innerHeight -50)
          .attr("dy", ".5em")
          .style("text-anchor", "end")
          .attr("fill", "#504f4f")
          .attr('font-size', '4em')
          .attr('font-weight', 'bold')
          .text(' ');

          //色盘
          allplatforms = Array.from(new Set(data.map(d => yValue(d))));
          colorScale.domain(allplatforms);
          const sp = d3.scalePoint().domain(allplatforms).range([0,1]);
          colorScale.range(allplatforms.map(d => d3.interpolateRainbow(sp(d))));
        };
      
        const render_update = async function(seq){
          //年份更新
          d3.select('#year').text(keyValue(seq[0]));

          //动画
          let transition = d3.transition().duration(aduration).ease(d3.easeLinear); 
          
          //坐标轴更新
          xScale.domain([0, d3.max(seq, xValue)]).range([0, innerWidth]); 
          yScale.domain(seq.map(yValue)).range([0, innerHeight]).padding(0.1);
          
          xAxisGroup.transition(transition).call(xAxisMethod);
          yAxisGroup.transition(transition).call(yAxisMethod);

          mainGroup.selectAll('.tick text').attr('font-size', '1.5em');

          //柱形图的进入和更新
          let rectupdates = mainGroup.selectAll('rect').data(seq, d => yValue(d));
          let rectenters = rectupdates.enter().append('rect')
          .attr('fill', d => colorScale(yValue(d)))
          .attr('opacity', .8)
          .attr('y', d => yScale(yValue(d)))
          .attr('width', 0)
          .attr('height', yScale.bandwidth());
            
          rectupdates.merge(rectenters).transition(transition)
          .attr('y', d => yScale(yValue(d)))
          .attr('width', d => xScale(xValue(d)))
          .attr('height', yScale.bandwidth());

          rectupdates.exit().remove();

          //数字的进入和更新
          let textupdates = mainGroup.selectAll('.globalsale_text').data(seq, d => yValue(d));
          let textenters = rectupdates.enter().append('text')
          .attr("class", "globalsale_text")
          .text('0.00')
          .attr('font-size', '0.8em')
          .attr('dx', 5)
          .attr('dy', 5)
          .attr('x', 0)
          .attr('y', d => yScale(yValue(d)) + yScale.bandwidth() / 2);
            
          textupdates.merge(textenters).transition(transition)
          .attr('x', d => xScale(xValue(d)))
          .attr('y', d => yScale(yValue(d)) + yScale.bandwidth() / 2)
          .tween("text", function(d) {
              var i = d3.interpolate(this.textContent, xValue(d));
              return function(t) {
                  this.textContent = formatPercent(i(t));
              };
          });

          textupdates.exit().remove()

          await transition.end();
        };

        d3.csv('Data/'+filename).then(async data => {
          data.forEach(datum => {
              datum.AQI = +(datum.AQI);
              datum.Season = +(datum.Season);
          });
          console.log(data)

          let data_per_year = {};
          allkeys = Array.from(new Set(data.map(d => keyValue(d))));
          allkeys.sort();
          allkeys.forEach(key => { data_per_year[key] = [] });
          data.forEach(d => {
              if (xValue(d) != -1) 
                data_per_year[keyValue(d)].push(d); 
          });
          allkeys.forEach(key => data_per_year[key].sort(function (a, b) {
                return xValue(b) - xValue(a);
          }));
          
          render_init(data);

          for(let i = 0; i < allkeys.length; i++){
              // console.log(allkeys[i]);
              // console.log(data_per_year[allkeys[i]])
              if (good == 'AQI最差')
                await render_update(data_per_year[allkeys[i]].slice(0, 20));
              else
                await render_update(data_per_year[allkeys[i]].slice(-20, -1).reverse());
          }
        })
    }

    /**
     * close the radar plot
     * @name CloseRadarPlot
     * @param null
     * @return null
     */
     function CloseRadarPlot(){
        var mapSvg = d3.select('#mapSvg')
        mapSvg.selectAll('#chart').remove()
        app.closeRadar = false
    }

    /**
     * go back the date of scatter plot 
     * @name DateGoBack
     * @param id<number>
     * @return null
     */
     function DateGoBack(id){
        console.log('DateGoBack', id)
        
        switch (id) {
            case 0:
                var divid = '#plotAQISvg'
                d3.select(divid).select('.plotg').remove()
                app.dateBack0 = false 
                DrawScatterPlot('#plotAQISvg', 'AQI')
                break;     
            case 1:
                var divid = '#plotPM25Svg'
                d3.select(divid).select('.plotg').remove()
                app.dateBack1 = false
                DrawScatterPlot('#plotPM25Svg', 'PM2.5')
                break;
            case 2:
                var divid = '#plotPM10Svg'
                d3.select(divid).select('.plotg').remove()
                app.dateBack2 = false 
                DrawScatterPlot('#plotPM10Svg', 'PM10')
                break;
            case 3:
                var divid = '#plotSO2Svg'
                d3.select(divid).select('.plotg').remove()
                app.dateBack3 = false 
                DrawScatterPlot('#plotSO2Svg', 'SO2')
                break;
            case 4:
                var divid = '#plotO3Svg'
                d3.select(divid).select('.plotg').remove()
                app.dateBack4 = false 
                DrawScatterPlot('#plotO3Svg', 'O3')
                break;
            case 5:
                var divid = '#plotCOSvg'
                d3.select(divid).select('.plotg').remove()
                app.dateBack5 = false 
                DrawScatterPlot('#plotCOSvg', 'CO')
                break;
        
            default:
                break;
        }

        app.showScaleCard = !(app.dateBack0 || app.dateBack1 || app.dateBack2 || app.dateBack3 || app.dateBack4 || app.dateBack5)
    }

    /**
     * go back the date of box plot 
     * @name BoxDateGoBack
     * @param id<number>
     * @return null
     */
     function BoxDateGoBack(id){
        console.log('BoxDateGoBack', id)
        
        switch (id) {
            case 0:
                var divid = '#plotAQISvg'
                d3.select(divid).select('.plotg').remove()
                app.boxDateBack0 = false 
                yearboxplot('#plotAQISvg', 'AQI')
                break;     
            case 1:
                var divid = '#plotPM25Svg'
                d3.select(divid).select('.plotg').remove()
                app.boxDateBack1 = false
                yearboxplot('#plotPM25Svg', 'PM2.5')
                break;
            case 2:
                var divid = '#plotPM10Svg'
                d3.select(divid).select('.plotg').remove()
                app.boxDateBack2 = false 
                yearboxplot('#plotPM10Svg', 'PM10')
                break;
            case 3:
                var divid = '#plotSO2Svg'
                d3.select(divid).select('.plotg').remove()
                app.boxDateBack3 = false 
                yearboxplot('#plotSO2Svg', 'SO2')
                break;
            case 4:
                var divid = '#plotO3Svg'
                d3.select(divid).select('.plotg').remove()
                app.boxDateBack4 = false 
                yearboxplot('#plotO3Svg', 'O3')
                break;
            case 5:
                var divid = '#plotCOSvg'
                d3.select(divid).select('.plotg').remove()
                app.boxDateBack5 = false 
                yearboxplot('#plotCOSvg', 'CO')
                break;
        
            default:
                break;
        }

        app.showScaleCard = !(app.dateBack0 || app.dateBack1 || app.dateBack2 || app.dateBack3 || app.dateBack4 || app.dateBack5)
    }


    /**
     * render the map in the first part
     * @name RenderMap
     * @param null
     * @return null
     */
    function RenderMap() {
        const mapSvg = d3.select('#mapSvg');
        const width = mapSvg.attr('width');
        const height = mapSvg.attr('height');
        const margin = { top: 60, right: 0, bottom: 0, left: 0 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;
        const mainGroup = mapSvg.append('g')
        .attr('id', 'mainGroup')
        .attr('transform', `translate(${margin.left}, ${margin.top})`);
        const tip = d3.tip().html((event, d) => d.properties.name);
        mapSvg.call(tip);
        tip.attr('class', 'd3-tip');

        const zoom = d3.zoom()
            .scaleExtent([1, 20])
            .on("zoom", (event, d) => {
                mainGroup.attr("transform", event.transform);
                zoomScale = event.transform.k;
                console.log(zoomScale);
                if (myTime != '')
                    RenderScatterPlot(myTarget, myTime, myYear, myMonth, myDay)
            })

        mapSvg.call(zoom);
        // mapSvg.call(zoom.transform, d3.zoomIdentity.translate(100, 100));

        d3.json('Data/china.json').then(async data => {
            //const projection = d3.geoNaturalEarth1();
            //const projection = d3.geoMercator();
            app.projection.fitSize([innerWidth, innerHeight], data);
            const path = d3.geoPath().projection(app.projection);
            mainGroup.selectAll('path').data(data.features).join('path')
                .attr('stroke', 'white')
                .attr('fill', function(d, i){
                    // return mapColors[i]
                    var index = (i%8)+2
                    if(i == 0){
                        mapColors(0)
                    }
                    else if(i == 8){
                        mapColors(8)
                    }
                    return mapColors(index)
                })
                .attr('opacity', 0.8)
                .attr('d', path)
                .attr('id', d => d.properties.name)
                .on('mouseover', tip.show)
                .on('mouseout', tip.hide);            
        });
    }

    /**
     * render the scatter plot of the specific time range
     * @name RenderScatterPlot
     * @param time<string>:the name of the input csv
     * @return null
     */
    function RenderScatterPlot(target, time, year, month, day) {
        console.log('==============' + 'RenderScatterPlot' + '===================')

        // const colorMap = [
        //     '#7FFF00',  // 0-50
        //     '#FFD700',  // 50-100
        //     '#FF8C00',  // 100-150
        //     '#FF0000',  // 150-200
        //     '#B22222',  // 200-300
        //     '#800000',  // 300+
        // ]
        const colorMap = [
            '#9BE441',  // 0-50
            '#FACF39',  // 50-100
            '#F89049',  // 100-150
            '#FF5555',  // 150-200
            '#A264BF',  // 200-300
            '#75365A',  // 300+
        ]

        const rangeMap = [
            [ // AQI
                50, 100, 150, 200, 300
            ],
            [ // PM2.5
                20, 50, 80, 120, 150
            ],
            [ // PM10
                50, 100, 150, 200, 300
            ],
            [ // SO2
                10, 30, 50, 70, 90
            ],
            [ // O3
                20, 40, 60, 80, 120,
            ],
            [ // CO
                0.5, 1, 2, 3, 4
            ]
        ]

        const maxAQI = 300
        const maxPM25 = 150
        const maxPM10 = 300
        const maxSO2 = 100
        const maxO3 = 100
        const maxCO = 3


        // console.log(target, time, year, month, day)
        var filename = 'Data_v2/' + target + '_' + time + 'mean.csv'
        console.log('Open file name', filename)

        d3.csv(filename).then(async data => {

            var renderData
            var renderDate
            
            if(time == 'day') {
                renderDate = year.toString() + month.toString().padStart(2, '0') + day.toString().padStart(2, '0')
            }
            else if(time == 'month') {
                renderDate = year.toString() + month.toString().padStart(2, '0')
            }
            else {
                renderDate = year.toString()
            }

            // console.log('renderDate', renderDate)
            
            for(var i = 0; i < data.length; i++){
                if(data[i][''] == renderDate){
                    // console.log('find date', data[i])
                    renderData = data[i]
                    break
                }
            }
            // console.log('renderData', renderData)            

            var locations = []
            var targetValue = []
            var cityName = []
            
            d3.csv('Data/citynamewithlocation.csv').then(locationData =>{
                // console.log('locationData', locationData)
                for(var key in renderData){
                    locationData.map(e=>{
                        if(key == e.City){
                            // console.log('find city', e)
                            var loc = new Array(parseFloat(e.Longtitude), parseFloat(e.Latitude))
                            locations.push(loc)
                            targetValue.push({
                                value: parseFloat(renderData[key]),
                                rate: e.Rate
                            })
                            cityName.push(key)
                        }
                    })
                }

                mainGroup = d3.select('#mainGroup')
                mainGroup.selectAll('#scatterCircle').remove()
                mainGroup.selectAll('.scatterText').remove()

                mainGroup.selectAll('circle')
                .data(locations)
                .enter().append('circle')
                .attr('cx', function(d) {
                    return app.projection(d)[0]
                })
                .attr('cy', function(d) {
                    return app.projection(d)[1]
                })
                .attr('opacity', 0.85)
                .attr('id', 'scatterCircle')
                .data(targetValue)
                .attr('display', function(d) {
                    if(d.value == -1) {
                        return 'none'
                    }
                    else {
                        if(zoomScale < 8)
                        {
                            if (d.rate == 3)
                                return 'none';
                        }
                    }
                })
                .attr('r', function(d){
                    if(zoomScale < 2){
                        return (circleRadius*3/4)/Math.sqrt(zoomScale)
                    }
                    else if(zoomScale < 4){
                        return (circleRadius*7/8)/Math.sqrt(zoomScale)
                    }
                    else{
                        return circleRadius/Math.sqrt(zoomScale)
                    }
                })
                .attr('fill', function(d) {
                    var rangeMapIndex
                    switch (target) {
                        case 'AQI':
                            rangeMapIndex = 0
                            break;
                        case 'PM2.5':
                            rangeMapIndex = 1
                            break;
                        case 'PM10':
                            rangeMapIndex = 2
                            break;
                        case 'SO2':
                            rangeMapIndex = 3
                            break;
                        case 'O3':
                            rangeMapIndex = 4
                            break;
                        case 'CO':
                            rangeMapIndex = 5
                            break;
                        default:
                            break;
                    }
                    if(d.value < rangeMap[rangeMapIndex][0]){
                        return colorMap[0]
                    }
                    else if(d.value < rangeMap[rangeMapIndex][1]){
                        return colorMap[1]
                    }
                    else if(d.value < rangeMap[rangeMapIndex][2]){
                        return colorMap[2]
                    }
                    else if(d.value < rangeMap[rangeMapIndex][3]){
                        return colorMap[3]
                    }
                    else if(d.value < rangeMap[rangeMapIndex][4]){
                        return colorMap[4]
                    }
                    else {
                        return colorMap[5]
                    }
                })
                .attr('stroke', 'black')
                .attr('stroke-width', 0.2)
                .data(cityName)
                .on('mouseover', (event, d) => {
                    mapSvg = d3.select('#mapSvg')
                    mapSvg.selectAll('#chart').remove()

                    app.closeRadar = true

                    var radarChart = mapSvg.append('g')
                    .attr('id', 'chart')
                    .attr('transform', function(d){
                        return `translate(${event.clientX - 275}, ${event.clientY - 70})`
                    })
                    .append("rect")
                    .attr('width', '180')
                    .attr('height', '180')
                    .attr("rx", 50)
                    .attr("fill", "white")
                    .attr('opacity', 0.8);           
                    
                    var AQIFilename = 'Data_v2/AQI_' + time + 'mean.csv'
                    var AQIValue = 0
                    d3.csv(AQIFilename).then(AQIData =>{
                        // console.log("RadarPlot AQI", AQIData)
                        var selectRow
                        for(var i = 0; i < AQIData.length; i++){
                            if(AQIData[i][''] == renderDate){
                                selectRow = AQIData[i]
                                break
                            }
                        }
                        AQIValue = selectRow[d]

                        var PM25Filename = 'Data_v2/PM2.5_' + time + 'mean.csv'
                        var PM25Value = 0
                        d3.csv(PM25Filename).then(PM25Data =>{
                            // console.log("RadarPlot PM25", PM25Data)
                            var selectRow
                            for(var i = 0; i < PM25Data.length; i++){
                                if(PM25Data[i][''] == renderDate){
                                    selectRow = PM25Data[i]
                                    break
                                }
                            }
                            PM25Value = selectRow[d]

                            var PM10Filename = 'Data_v2/PM10_' + time + 'mean.csv'
                            var PM10Value = 0
                            d3.csv(PM10Filename).then(PM10Data =>{
                                // console.log("RadarPlot PM10", PM10Data)
                                var selectRow
                                for(var i = 0; i < PM10Data.length; i++){
                                    if(PM10Data[i][''] == renderDate){
                                        selectRow = PM10Data[i]
                                        break
                                    }
                                }
                                PM10Value = selectRow[d]

                                var SO2Filename = 'Data_v2/SO2_' + time + 'mean.csv'
                                var SO2Value = 0
                                d3.csv(SO2Filename).then(SO2Data =>{
                                    // console.log("RadarPlot SO2", SO2Data)
                                    var selectRow
                                    for(var i = 0; i < SO2Data.length; i++){
                                        if(SO2Data[i][''] == renderDate){
                                            selectRow = SO2Data[i]
                                            break
                                        }
                                    }
                                    SO2Value = selectRow[d]

                                    var O3Filename = 'Data_v2/O3_' + time + 'mean.csv'
                                    var O3Value = 0
                                    d3.csv(O3Filename).then(O3Data =>{
                                        // console.log("RadarPlot O3", O3Data)
                                        var selectRow
                                        for(var i = 0; i < O3Data.length; i++){
                                            if(O3Data[i][''] == renderDate){
                                                selectRow = O3Data[i]
                                                break
                                            }
                                        }
                                        O3Value = selectRow[d]

                                        var COFilename = 'Data_v2/CO_' + time + 'mean.csv'
                                        var COValue = 0
                                        d3.csv(COFilename).then(COData =>{
                                            // console.log("RadarPlot CO", COData)
                                            var selectRow
                                            for(var i = 0; i < COData.length; i++){
                                                if(COData[i][''] == renderDate){
                                                    selectRow = COData[i]
                                                    break
                                                }
                                            }
                                            COValue = selectRow[d]

                                            // console.log("Value", AQIValue, PM25Value, PM10Value, SO2Value, O3Value, COValue)

                                            var radarPlotData = []
                                            radarPlotData.push(renderDate)
                                            radarPlotData.push(AQIValue/maxAQI)
                                            radarPlotData.push(PM25Value/maxPM25)
                                            radarPlotData.push(PM10Value/maxPM10)
                                            radarPlotData.push(SO2Value/maxSO2)
                                            radarPlotData.push(O3Value/maxO3)
                                            radarPlotData.push(COValue/maxCO)
                                            
                                            // console.log("render data", radarPlotData)
                                            radar('#chart', 'type.csv', radarPlotData, d);
                                        });
                                    });
                                });
                            });
                        });

                    });
                })
                .on('click', (event, d)=>{
                    app.selectCity = d
                    ReadHistoryData()
                    app.menuId = '2'
                    app.handleSpinCustom()
                })                
                

                mainGroup.selectAll('text')
                .data(locations)
                .enter()
                .append('text')
                .attr('font-size', 0.55/Math.sqrt(zoomScale)+'em')
                // .attr('fill', '#FFFFFFF')
                .attr('text-anchor', 'middle')
                .attr('transform', function(d){
                    return `translate(${app.projection(d)[0] - (circleRadius/Math.sqrt(zoomScale))*1/16}, ${app.projection(d)[1] + (circleRadius/Math.sqrt(zoomScale))*7/16})`
                })
                .attr('class', 'scatterText')
                .data(targetValue)
                .attr('display', function(d) {
                    if(d.value == -1) {
                        return 'none'
                    }
                    else {
                        if(zoomScale < 4)
                        {
                            return 'none';
                        }
                        else if(zoomScale < 8)
                        {
                            if (d.rate == 3)
                                return 'none';
                        }
                        else {
                            return 'flex'
                        }
                    }
                })
                .attr('disabled', true)
                .text(function(d){
                    switch (target) {
                        case 'AQI':
                            return d.value.toFixed(0)
                            break;
                        case 'PM2.5':
                            return d.value.toFixed(0)   
                            break;
                        case 'PM10':
                            return d.value.toFixed(0)
                            break;
                        case 'SO2':
                            return d.value.toFixed(0)
                            break;
                        case 'O3':
                            return d.value.toFixed(0)
                            break;
                        case 'CO':
                            return d.value.toFixed(1)
                            break;
                        default:
                            break;
                    }
                })
            });
        });
      
    }

     /**
     * read history data for scatter plot, box plot and line plot
     * @name ReadHistoryData
     * @param null
     * @return null
     */
    function ReadHistoryData(){
        console.log("ReadHistoryData()", app.selectCity)
        d3.csv('Data_v2/AQI_daymean.csv').then(data =>{
            // console.log('AQI data', data)
            for(var i = 0; i < app.AQIDayMean.length; i++){
                app.AQIDayMean[i].value= data[i][app.selectCity]
            }

            d3.csv('Data_v2/PM2.5_daymean.csv').then(data =>{
                for(var i = 0; i < app.PM25DayMean.length; i++){
                    app.PM25DayMean[i].value= data[i][app.selectCity]
                }

                d3.csv('Data_v2/PM10_daymean.csv').then(data =>{
                    for(var i = 0; i < app.PM10DayMean.length; i++){
                        app.PM10DayMean[i].value= data[i][app.selectCity]
                    }

                    d3.csv('Data_v2/SO2_daymean.csv').then(data =>{
                        for(var i = 0; i < app.SO2DayMean.length; i++){
                            app.SO2DayMean[i].value= data[i][app.selectCity]
                        }

                        d3.csv('Data_v2/O3_daymean.csv').then(data =>{
                            for(var i = 0; i < app.O3DayMean.length; i++){
                                app.O3DayMean[i].value= data[i][app.selectCity]
                            }

                            d3.csv('Data_v2/CO_daymean.csv').then(data =>{
                                for(var i = 0; i < app.CODayMean.length; i++){
                                    app.CODayMean[i].value= data[i][app.selectCity]
                                }

                                ChangePlot()
                            })
                        })
                    })
                })
            })
        })

        
    }

    /**
     * change the plot category
     * @name ChangePlot
     * @param null
     * @return null
     */
    function ChangePlot() {
        console.log('==============' + 'ChangePlot' + '===================')
        if(app.selectPlot == '散点图/折线图'){
            app.showScaleCard = true
            app.boxDateBack0 = false
            app.boxDateBack1 = false
            app.boxDateBack2 = false
            app.boxDateBack3 = false
            app.boxDateBack4 = false
            app.boxDateBack5 = false

            d3.selectAll('.plotg').remove()
            // draw scatter plot
            DrawScatterPlot('#plotAQISvg', 'AQI')
            DrawScatterPlot('#plotPM25Svg', 'PM2.5')
            DrawScatterPlot('#plotPM10Svg', 'PM10')
            DrawScatterPlot('#plotSO2Svg', 'SO2')
            DrawScatterPlot('#plotO3Svg', 'O3')
            DrawScatterPlot('#plotCOSvg', 'CO')
        }
        else{
            app.showScaleCard = false
            app.dateBack0 = false
            app.dateBack1 = false
            app.dateBack2 = false
            app.dateBack3 = false
            app.dateBack4 = false
            app.dateBack5 = false

            // draw box plot
            d3.selectAll('.plotg').remove()
            yearboxplot('#plotAQISvg', 'AQI')
            yearboxplot('#plotPM25Svg', 'PM2.5')
            yearboxplot('#plotPM10Svg', 'PM10')
            yearboxplot('#plotSO2Svg', 'SO2')
            yearboxplot('#plotO3Svg', 'O3')
            yearboxplot('#plotCOSvg', 'CO')
        }
    }

    const yearboxplot = function (divid, target) {
        let gg = d3.select(divid)
        let mainGroup = gg.append('g')
            .attr('class', 'plotg')
            .attr('transform', `translate(${-100}, ${0})`);

        var innerHeight = gg.attr('height')
        var innerWidth = gg.attr('width')

        const xScale = d3.scaleBand();
        const yScale = d3.scaleLinear();
        const xAxisMethod = d3.axisBottom(xScale);
        const yAxisMethod = d3.axisLeft(yScale);  
        const xAxisGroup = mainGroup.append('g')
            .attr('transform', `translate(${0}, ${innerHeight})`)
            .attr('id', 'xaxis');
        const yAxisGroup = mainGroup.append('g')
            .attr('id', 'yaxis');

        
        const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
        const years = [2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021];
        var myCity = app.selectCity;

        d3.csv('Data_v2/'+target+'_daymean.csv').then(async data => {
            var yearData = {};
            var yearDataWithTime = {};
            var boxplotData = [];
            years.forEach(key => { yearData[key] = []; yearDataWithTime[key] = [] });
            data.forEach(d => {
                d[myCity] = +(d[myCity]);
                if (d[myCity] != -1) 
                {
                    yearData[d[''].slice(0,4)].push(d[myCity]);
                    yearDataWithTime[d[''].slice(0,4)].push([d[''], d[myCity]]);
                }
            });
            console.log(yearDataWithTime);
            console.log(data);

            //boxplotData.length = 0;
            years.forEach(key => {
                var tmpData = yearData[key];
                var data_sorted = tmpData.sort(d3.ascending);
                var q1 = d3.quantile(data_sorted, .25);
                var median = d3.quantile(data_sorted, .5);
                var q3 = d3.quantile(data_sorted, .75);
                var interQuantileRange = q3 - q1;
                var min = q1 - 1.5 * interQuantileRange;
                var max = q1 + 1.5 * interQuantileRange;
                boxplotData.push({key: key, q1: q1, median: median, q3: q3, interQuantileRange: interQuantileRange, min: min, max: max});
            });

            xScale.domain(years).range([0, innerWidth - 300]).padding(0.1); 
            yScale.domain([d3.min(boxplotData, d => d.min), d3.max(boxplotData, d => d.max)]).range([innerHeight - 120, 0]);

            xAxisGroup.call(xAxisMethod);
            yAxisGroup.call(yAxisMethod);
            xAxisGroup.attr('transform', `translate(${200}, ${innerHeight-70})`);
            yAxisGroup.attr('transform', `translate(${200}, ${50})`);

            switch (target) {
                    case 'AQI':
                        app.boxDateBack0 = false
                        break;
                    case 'PM2.5':
                        app.boxDateBack1 = false
                        break;
                    case 'PM10':
                        app.boxDateBack2 = false
                        break;
                    case 'SO2':
                        app.boxDateBack3 = false
                        break;
                    case 'O3':
                        app.boxDateBack4 = false
                        break;
                    case 'CO':
                        app.boxDateBack5 = false
                        break;
                
                    default:
                        break;
                }
            drawboxplot(boxplotData, divid, target, xScale, yScale, innerHeight, innerWidth);
        
            d3.selectAll('.boxrect')
            .on('mouseover', (event, d) => {
                d3.select(event.currentTarget).attr('fill', '#F4A460');
            })
            .on('mouseout', (event, d) => {
                d3.select(event.currentTarget).attr('fill', '#69b3a2');
            })
            .on('click', (event, d) => {
                var monthData = {};
                months.forEach(key => { monthData[key] = [] });
                yearDataWithTime[d.key+''].forEach(d => { 
                    monthData[d[0].slice(4,6)].push(d[1]);
                });
                var boxplotData = [];
                //boxplotData.length = 0;
                months.forEach(key => {
                    var tmpData = monthData[key];
                    if (tmpData.length > 0)
                    {
                        var data_sorted = tmpData.sort(d3.ascending);
                        var q1 = d3.quantile(data_sorted, .25);
                        var median = d3.quantile(data_sorted, .5);
                        var q3 = d3.quantile(data_sorted, .75);
                        var interQuantileRange = q3 - q1;
                        var min = q1 - 1.5 * interQuantileRange;
                        var max = q1 + 1.5 * interQuantileRange;
                        boxplotData.push({key: key, q1: q1, median: median, q3: q3, interQuantileRange: interQuantileRange, min: min, max: max});
                    }
                });
                var target = d3.select(event.currentTarget).attr('id').slice(0, -4);
                var divid = '#plot'+target+'Svg';
                if (target == 'PM2.5')
                    divid = '#plotPM25Svg';
                xScale.domain(months).range([0, innerWidth - 300]).padding(0.1); 
                yScale.domain([d3.min(boxplotData, d => d.min), d3.max(boxplotData, d => d.max)]).range([innerHeight - 120, 0]);
                var xAxisGroup = d3.select(divid).selectAll('.plotg').select('#xaxis');
                var yAxisGroup = d3.select(divid).selectAll('.plotg').select('#yaxis');
                xAxisGroup.call(xAxisMethod);
                yAxisGroup.call(yAxisMethod);
                xAxisGroup.attr('transform', `translate(${200}, ${innerHeight-70})`);
                yAxisGroup.attr('transform', `translate(${200}, ${50})`);
                switch (target) {
                    case 'AQI':
                        app.boxDateBack0 = true
                        break;
                    case 'PM2.5':
                        app.boxDateBack1 = true
                        break;
                    case 'PM10':
                        app.boxDateBack2 = true
                        break;
                    case 'SO2':
                        app.boxDateBack3 = true
                        break;
                    case 'O3':
                        app.boxDateBack4 = true
                        break;
                    case 'CO':
                        app.boxDateBack5 = true
                        break;
                
                    default:
                        break;
                }
                drawboxplot(boxplotData, divid, target, xScale, yScale, innerHeight, innerWidth);
            });
        })
    }

    const drawboxplot = function (boxplotData, divid, target, xScale, yScale, innerHeight, innerWidth) {
        mainGroup = d3.select(divid).selectAll('.plotg');
        let transition = d3.transition().duration(1000).ease(d3.easeLinear);
        mainGroup.selectAll('.vline').remove();
        let vlineupdates = mainGroup.selectAll('.vline').data(boxplotData);
        let vlineenters = vlineupdates.enter().append('line')
        .attr('class', 'vline')
        .attr("stroke", "black")
        .attr('transform', `translate(${200}, ${50})`)
        .attr('x1', d => xScale(d.key)+xScale.bandwidth()/2)
        .attr('x2', d => xScale(d.key)+xScale.bandwidth()/2)
        .attr('y1', innerHeight-120)
        .attr('y2', innerHeight-120);      
        vlineupdates.merge(vlineenters).transition(transition)
        .attr('y1', d => yScale(d.min))
        .attr('y2', d => yScale(d.max));

        mainGroup.selectAll('.boxrect').remove();
        let rectupdates = mainGroup.selectAll('.boxrect').data(boxplotData);
        let rectenters = rectupdates.enter().append('rect')
        .attr('class', 'boxrect')
        .attr('id', target+'rect')
        .attr('fill', "#69b3a2")
        .attr("stroke", "black")
        .attr('transform', `translate(${200}, ${50})`)
        .attr('x', d => xScale(d.key)+xScale.bandwidth()/4)
        .attr('width', xScale.bandwidth()/2)
        .attr('y', innerHeight-120)
        .attr('height', 0);      
        rectupdates.merge(rectenters).transition(transition)
        .attr('y', d => yScale(d.q3))
        .attr('height', d => yScale(d.q1) - yScale(d.q3));
        
        mainGroup.selectAll('.medianline').remove();
        let medianlineupdates = mainGroup.selectAll('.medianline').data(boxplotData);
        let medianlineenters = medianlineupdates.enter()
        .append('line')
        .attr('class', 'medianline')
        .attr("stroke", "black")
        .attr('transform', `translate(${200}, ${50})`)
        .attr('x1', d => xScale(d.key)+xScale.bandwidth()/4)
        .attr('x2', d => xScale(d.key)+xScale.bandwidth()*3/4)
        .attr('y1', innerHeight-120)
        .attr('y2', innerHeight-120);     
        medianlineupdates.merge(medianlineenters).transition(transition)
        .attr('y1', d => yScale(d.median))
        .attr('y2', d => yScale(d.median));  

        mainGroup.selectAll('.minline').remove();
        let minlineupdates = mainGroup.selectAll('.minline').data(boxplotData);
        let minlineenters = minlineupdates.enter()
        .append('line')
        .attr('class', 'minline')
        .attr("stroke", "black")
        .attr('transform', `translate(${200}, ${50})`)
        .attr('x1', d => xScale(d.key)+xScale.bandwidth()/4)
        .attr('x2', d => xScale(d.key)+xScale.bandwidth()*3/4)
        .attr('y1', innerHeight-120)
        .attr('y2', innerHeight-120);     
        minlineupdates.merge(minlineenters).transition(transition)
        .attr('y1', d => yScale(d.min))
        .attr('y2', d => yScale(d.min)); 
        
        mainGroup.selectAll('.maxline').remove();
        let maxlineupdates = mainGroup.selectAll('.maxline').data(boxplotData);
        let maxlineenters = maxlineupdates.enter()
        .append('line')
        .attr('class', 'maxline')
        .attr("stroke", "black")
        .attr('transform', `translate(${200}, ${50})`)
        .attr('x1', d => xScale(d.key)+xScale.bandwidth()/4)
        .attr('x2', d => xScale(d.key)+xScale.bandwidth()*3/4)
        .attr('y1', innerHeight-120)
        .attr('y2', innerHeight-120);     
        maxlineupdates.merge(maxlineenters).transition(transition)
        .attr('y1', d => yScale(d.max))
        .attr('y2', d => yScale(d.max));
    }

    /**
     * draw scatter plot of specified target
     * @name DrawScatterPlot
     * @param divid<string> the id of svg; target<string> the name of target
     * @return null
     */
    function DrawScatterPlot(divid, target){
        var targetData
        var yLabel
        var scaleDomain
        var colorIndex
        const domainRange = [
            [520, 500, 700, 150, 200, 10],
            [400, 300, 300, 100, 150, 5]
        ]
        var domainRangeIndex
        var dateBackIndex
        switch (app.selectScale) {
            case '全局':
                domainRangeIndex = 0
                break;
            case '局部':
                domainRangeIndex = 1
                break;
            default:
                break;
        }

        switch (target) {
            case 'AQI':
                targetData = app.AQIDayMean
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][0]
                colorIndex = 0
                dateBackIndex = 0
                app.dateBack0 = false 
                break;
            case 'PM2.5':
                targetData = app.PM25DayMean
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][1]
                colorIndex = 1
                dateBackIndex = 1
                app.dateBack1 = false
                break;
            case 'PM10':
                targetData = app.PM10DayMean
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][2]
                colorIndex = 2
                dateBackIndex = 2
                app.dateBack2 = false
                break;
            case 'SO2':
                targetData = app.SO2DayMean
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][3]
                colorIndex = 3
                dateBackIndex = 3
                app.dateBack3 = false
                break;
            case 'O3':
                targetData = app.O3DayMean
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][4]
                colorIndex = 0
                dateBackIndex = 4
                app.dateBack4 = false
                break;
            case 'CO':
                targetData = app.CODayMean
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][5]
                colorIndex = 1
                dateBackIndex = 5
                app.dateBack5 = false
                break;
            default:
                break;
        }

        const xValue = d => d.date;
        const yValue = d => d.value;
        
        let xScale, yScale;
        const xBarValue = (datum) => {return datum.date};
        const yBarValue = (datum) => {return datum.value};
        const xAxisLabel = 'date';
        const yAxisLabel = yLabel;

        let gg = d3.select(divid)
        let g = gg.append('g')
        .attr('class', 'plotg')
        .attr('transform', `translate(${-100}, ${0})`);

        var innerHeight = gg.attr('height')
        var innerWidth = gg.attr('width')

        
        xScale = d3.scaleTime()
        .domain([new Date(2014, 3, 14), new Date(2021, 4, 19)])
        .range([0, innerWidth-300])
        
        yScale = d3.scaleLinear()
        .domain([0, scaleDomain].reverse())
        .range([0, innerHeight-120])
        

        const xAxisMethod = d3.axisBottom(xScale).ticks(10);
        const yAxisMethod = d3.axisLeft(yScale).ticks(5);
        const xAxisGroup = g.append('g').call(xAxisMethod)
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');
        // xAxisGroup.append('text')
        // .attr('font-size', '1em')
        // .attr('y', 60)
        // .attr('x', innerWidth / 2 - 100)
        // .attr('fill', '#504f4f')
        // .text(xAxisLabel)
        // .attr('text-anchor', 'middle') 

        const yAxisGroup = g.append('g').call(yAxisMethod)
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');
        yAxisGroup.append('text')
        .attr('font-size', '1em')
        .attr("font-family", 'Microsoft YaHei') 
        .attr('transform', `rotate(-90)`)
        .attr('x', -(innerHeight - 100) / 2)
        .attr('y', -70)
        .attr('fill', '#504f4f')
        .text(yAxisLabel)
        .attr('text-anchor', 'middle') 

        xAxisGroup.attr('transform', `translate(${200}, ${innerHeight-70})`);
        yAxisGroup.attr('transform', `translate(${200}, ${50})`);

        var dates = [
            [new Date(2014, 3, 14), new Date(2015, 0, 1)],
            [new Date(2015, 0, 1), new Date(2016, 0, 1)],
            [new Date(2016, 0, 1), new Date(2017, 0, 1)],
            [new Date(2017, 0, 1), new Date(2018, 0, 1)],
            [new Date(2018, 0, 1), new Date(2019, 0, 1)],
            [new Date(2019, 0, 1), new Date(2020, 0, 1)],
            [new Date(2020, 0, 1), new Date(2021, 0, 1)],
            [new Date(2021, 0, 1), new Date(2021, 4, 19)]
        ];
        
        g.selectAll(".dot")
        .data(targetData)
        .enter().append("circle") // Uses the enter().append() method
        .attr("class", "dot") // Assign a class for styling
        .attr("cx", function(d, i) { 
            return xScale(d.date) 
        })
        .attr("cy", function(d) { 
            return yScale(d.value) 
        })
        .attr("r", 2)
        .attr('transform', `translate(${200}, ${50})`)
        .attr('display', function(d){
            if(d.value == -1.0){
                return 'none'
            }
            return 'block'
        })
        .attr('fill', function(d){
            return mapColors(8-colorIndex)
        })

        g.selectAll(".highlightarea").data(dates).join('rect')
            .attr('class', 'highlightarea')
            .attr('x', d => xScale(d[0]))
            .attr('y', 0)
            .attr('width', d => xScale(d[1])-xScale(d[0]))
            .attr('height', innerHeight-120)
            .attr('fill', '#DCDCDC')
            .attr('opacity', 0)
            .attr('transform', `translate(${200}, ${50})`)
            .on('mouseover', (event, d) => {
                d3.select(event.currentTarget).attr('opacity', 0.3);
                highlightedYear = d;
                g.selectAll(".dot").data(targetData)
                .attr('fill', function(d){
                    if (d.date >= highlightedYear[0] && d.date < highlightedYear[1])
                        return 'purple';
                    else
                        return mapColors(8-colorIndex);
                })
            })
            .on('mouseout', (event, d) => {
                d3.select(event.currentTarget).attr('opacity', 0);
                hightlightedYear = [];
                g.selectAll(".dot").data(targetData)
                .attr('fill', function(d){
                    return mapColors(8-colorIndex);
                })
            })
            .on('click', (event, d) => {
                var targetDataYear = [];
                targetData.forEach(datum => { 
                    if (datum.date >= d[0] && datum.date < d[1])
                        targetDataYear.push(datum);
                })
                g.remove();

                switch (target) {
                    case 'AQI':
                        app.dateBack0 = true
                        break;
                    case 'PM2.5':
                        app.dateBack1 = true
                        break;
                    case 'PM10':
                        app.dateBack2 = true
                        break;
                    case 'SO2':
                        app.dateBack3 = true
                        break;
                    case 'O3':
                        app.dateBack4 = true
                        break;
                    case 'CO':
                        app.dateBack5 = true
                        break;
                
                    default:
                        break;
                }
                app.showScaleCard = false

                DrawScatterPlotYear(divid, target, targetDataYear, d);
                console.log(targetDataYear);
            });
    }

    /**
     * draw scatter plot of specified target
     * @name DrawScatterPlotYear
     * @param divid<string> the id of svg; target<string> the name of target; targetDataYear[] data for rendering; year[] selected year
     * @return null
     */
     async function DrawScatterPlotYear(divid, target, targetDataYear, year){
        var yLabel
        var scaleDomain
        var colorIndex
        const domainRange = [
            [520, 500, 700, 150, 200, 10],
            [400, 300, 300, 100, 150, 5]
        ]
        var domainRangeIndex
        switch (app.selectScale) {
            case '全局':
                domainRangeIndex = 0
                break;
            case '局部':
                domainRangeIndex = 1
                break;
            default:
                break;
        }

        switch (target) {
            case 'AQI':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][0]
                colorIndex = 0
                break;
            case 'PM2.5':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][1]
                colorIndex = 1
                break;
            case 'PM10':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][2]
                colorIndex = 2
                break;
            case 'SO2':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][3]
                colorIndex = 3
                break;
            case 'O3':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][4]
                colorIndex = 0
                break;
            case 'CO':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][5]
                colorIndex = 1
                break;
            default:
                break;
        }


        const xValue = d => d.date;
        const yValue = d => d.value;
        
        let xScale, yScale;
        const xBarValue = (datum) => {return datum.date};
        const yBarValue = (datum) => {return datum.value};
        const xAxisLabel = 'date';
        const yAxisLabel = yLabel;
        let transition = d3.transition().duration(1000).ease(d3.easeLinear);

        let gg = d3.select(divid)
        let g = gg.append('g')
        .attr('class', 'plotg')
        .attr('transform', `translate(${-100}, ${0})`);

        var innerHeight = gg.attr('height')
        var innerWidth = gg.attr('width')

        
        xScale = d3.scaleTime()
        .domain(year)
        .range([0, innerWidth-270])
        
        yScale = d3.scaleLinear()
        .domain([0, d3.max(targetDataYear, d => +(d.value))])
        .range([innerHeight-120, 0])
        

        const xAxisMethod = d3.axisBottom(xScale);
        const yAxisMethod = d3.axisLeft(yScale).ticks(5);
        const xAxisGroup = g.append('g').call(xAxisMethod)
              .attr('font-size', '0.9em')
              .attr('font-weight', 'bold');
        // xAxisGroup.append('text')
        // .attr('font-size', '1em')
        // .attr('y', 60)
        // .attr('x', innerWidth / 2 - 100)
        // .attr('fill', '#504f4f')
        // .text(xAxisLabel)
        // .attr('text-anchor', 'middle') 

        const yAxisGroup = g.append('g').call(yAxisMethod)
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');
        yAxisGroup.append('text')
        .attr('font-size', '1em')
        .attr("font-family", 'Microsoft YaHei') 
        .attr('transform', `rotate(-90)`)
        .attr('x', -(innerHeight - 100) / 2)
        .attr('y', -70)
        .attr('fill', '#504f4f')
        .text(yAxisLabel)
        .attr('text-anchor', 'middle') 

        xAxisGroup.attr('transform', `translate(${200}, ${innerHeight-70})`);
        yAxisGroup.attr('transform', `translate(${200}, ${50})`);

        var dates = [];
        fullyear = year[0].getFullYear();
        if (fullyear == 2014)
        {
            dates = [[new Date(fullyear, 4, 14), new Date(fullyear, 5, 1)]];
            for (let i = 5; i < 11; i++)
                dates.push([new Date(fullyear, i, 1), new Date(fullyear, i+1, 1)]);
            dates.push([new Date(fullyear, 11, 1), new Date(fullyear+1, 0, 1)]);
        }
        else if (fullyear == 2021)
        {
            dates = [
                [new Date(fullyear, 0, 1), new Date(fullyear, 1, 1)],
                [new Date(fullyear, 1, 1), new Date(fullyear, 2, 1)],
                [new Date(fullyear, 2, 1), new Date(fullyear, 3, 1)],
                [new Date(fullyear, 3, 1), new Date(fullyear, 3, 19)]
            ];
        }
        else
        {
            for (let i = 0; i < 11; i++)
                dates.push([new Date(fullyear, i, 1), new Date(fullyear, i+1, 1)]);
            dates.push([new Date(fullyear, 11, 1), new Date(fullyear+1, 0, 1)]);
        }

        const line = d3.line()
            .x(d => { return xScale(xValue(d)) })
            .y(d => { return yScale(+(yValue(d))) })
            .curve(d3.curveCardinal.tension(0.5))

        const lineEmpty = d3.line()
            .x(d => { return xScale(xValue(d)) })
            .y(d => { return yScale(0) })
            .curve(d3.curveCardinal.tension(0.5))

        const pathupdate = g.selectAll('.datacurve').data([targetDataYear])
        const pathenter = pathupdate.enter().append('path')
            .attr('class', 'datacurve')
            .attr('fill', 'none')
            .attr('stroke', mapColors(8-colorIndex))
            .attr('stroke-width', 2)
            .attr('d', lineEmpty)
            .attr('transform', `translate(${200}, ${50})`)
        pathupdate.merge(pathenter)
            .transition(transition)
            .attr('d', line)
        
        const dotupdate = g.selectAll('.dot').data(targetDataYear)
        const dotenter = dotupdate.enter().append('circle')
            .attr("class", "dot") // Assign a class for styling
            .attr("cx", d => xScale(d.date))
            .attr("cy", d => yScale(0))
            .attr("r", 2)
            .attr('transform', `translate(${200}, ${50})`)
            .attr('display', function(d){
                if(d.value == -1.0){
                    return 'none'
                }
                return 'block'
            })
            .attr('fill', mapColors(8-colorIndex))
        dotupdate.merge(dotenter)
            .transition(transition)
            .attr('cy', d => yScale(+(d.value)))

        await transition.end();

        g.selectAll(".highlightarea").data(dates).join('rect')
            .attr('class', 'highlightarea')
            .attr('x', d => xScale(d[0]))
            .attr('y', 0)
            .attr('width', d => xScale(d[1])-xScale(d[0]))
            .attr('height', innerHeight-120)
            .attr('fill', '#DCDCDC')
            .attr('opacity', 0)
            .attr('transform', `translate(${200}, ${50})`)
            .on('mouseover', (event, d) => {
                d3.select(event.currentTarget).attr('opacity', 0.3);
                highlightedMonth = d;
                g.selectAll(".dot").data(targetDataYear)
                .attr('fill', function(d){
                    if (d.date >= highlightedMonth[0] && d.date < highlightedMonth[1])
                        return 'purple';
                    else
                        return mapColors(8-colorIndex);
                })
                var targetDataMonth = [];
                targetDataYear.forEach(datum => { 
                    if (datum.date >= d[0] && datum.date < d[1])
                        targetDataMonth.push(datum);
                })
                g.selectAll('.datacure_h').data([targetDataMonth]).join('path')
                    .attr('class', 'datacurve_h')
                    .attr('fill', 'none')
                    .attr('stroke-width', 2.5)
                    .attr('d', line)
                    .attr('transform', `translate(${200}, ${50})`)
                    .attr('stroke', 'purple')
            })
            .on('mouseout', (event, d) => {
                d3.select(event.currentTarget).attr('opacity', 0);
                hightlightedMonth = [];
                g.selectAll(".dot").data(targetDataYear)
                .attr('fill', function(d){
                    return mapColors(8-colorIndex);
                })
                g.selectAll(".datacurve_h").remove();
            })
            .on('click', (event, d) => {
                var targetDataMonth = [];
                targetDataYear.forEach(datum => { 
                    if (datum.date >= d[0] && datum.date < d[1])
                        targetDataMonth.push(datum);
                })
                g.remove();
                DrawScatterPlotMonth(divid, target, targetDataMonth, d);
                console.log(targetDataMonth);
            });
    }

    /**
     * draw scatter plot of specified target
     * @name DrawScatterPlotMonth
     * @param divid<string> the id of svg; target<string> the name of target; targetDataYear[] data for rendering; year[] selected month
     * @return null
     */
    function DrawScatterPlotMonth(divid, target, targetDataMonth, month){
        var yLabel
        var scaleDomain
        var colorIndex
        const domainRange = [
            [520, 500, 700, 150, 200, 10],
            [400, 300, 300, 100, 150, 5]
        ]
        var domainRangeIndex
        switch (app.selectScale) {
            case '全局':
                domainRangeIndex = 0
                break;
            case '局部':
                domainRangeIndex = 1
                break;
            default:
                break;
        }

        switch (target) {
            case 'AQI':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][0]
                colorIndex = 0
                break;
            case 'PM2.5':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][1]
                colorIndex = 1
                break;
            case 'PM10':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][2]
                colorIndex = 2
                break;
            case 'SO2':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][3]
                colorIndex = 3
                break;
            case 'O3':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][4]
                colorIndex = 0
                break;
            case 'CO':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][5]
                colorIndex = 1
                break;
            default:
                break;
        }


        const xValue = d => d.date;
        const yValue = d => d.value;
        
        let xScale, yScale;
        const xBarValue = (datum) => {return datum.date};
        const yBarValue = (datum) => {return datum.value};
        const xAxisLabel = 'date';
        const yAxisLabel = yLabel;
        let transition = d3.transition().duration(1000).ease(d3.easeLinear);

        let gg = d3.select(divid)
        let g = gg.append('g')
        .attr('class', 'plotg')
        .attr('transform', `translate(${-100}, ${0})`);

        var innerHeight = gg.attr('height')
        var innerWidth = gg.attr('width')

        
        xScale = d3.scaleTime()
        .domain(month)
        .range([0, innerWidth-270])
        
        yScale = d3.scaleLinear()
        .domain([0, d3.max(targetDataMonth, d => +(d.value))])
        .range([innerHeight-120, 0])
        

        const xAxisMethod = d3.axisBottom(xScale).ticks(8);
        const yAxisMethod = d3.axisLeft(yScale).ticks(5);
        const xAxisGroup = g.append('g').call(xAxisMethod)
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');
        // xAxisGroup.append('text')
        // .attr('font-size', '1em')
        // .attr('y', 60)
        // .attr('x', innerWidth / 2 - 100)
        // .attr('fill', '#504f4f')
        // .text(xAxisLabel)
        // .attr('text-anchor', 'middle') 

        const yAxisGroup = g.append('g').call(yAxisMethod)
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');
        yAxisGroup.append('text')
        .attr('font-size', '1em')
        .attr("font-family", 'Microsoft YaHei') 
        .attr('transform', `rotate(-90)`)
        .attr('x', -(innerHeight - 100) / 2)
        .attr('y', -70)
        .attr('fill', '#504f4f')
        .text(yAxisLabel)
        .attr('text-anchor', 'middle') 

        xAxisGroup.attr('transform', `translate(${200}, ${innerHeight-70})`);
        yAxisGroup.attr('transform', `translate(${200}, ${50})`);

        const line = d3.line()
            .x(d => { return xScale(xValue(d)) })
            .y(d => { return yScale(+(yValue(d))) })
            .curve(d3.curveCardinal.tension(0.5))

        const lineEmpty = d3.line()
            .x(d => { return xScale(xValue(d)) })
            .y(d => { return yScale(0) })
            .curve(d3.curveCardinal.tension(0.5))

        const pathupdate = g.selectAll('.datacurve').data([targetDataMonth])
        const pathenter = pathupdate.enter().append('path')
            .attr('class', 'datacurve')
            .attr('fill', 'none')
            .attr('stroke', mapColors(8-colorIndex))
            .attr('stroke-width', 2)
            .attr('d', lineEmpty)
            .attr('transform', `translate(${200}, ${50})`)
        pathupdate.merge(pathenter)
            .transition(transition)
            .attr('d', line)
        
        const dotupdate = g.selectAll('.dot').data(targetDataMonth)
        const dotenter = dotupdate.enter().append('circle')
            .attr("class", "dot") // Assign a class for styling
            .attr("cx", d => xScale(d.date))
            .attr("cy", d => yScale(0))
            .attr("r", 2)
            .attr('transform', `translate(${200}, ${50})`)
            .attr('display', function(d){
                if(d.value == -1.0){
                    return 'none'
                }
                return 'block'
            })
            .attr('fill', mapColors(8-colorIndex))
        dotupdate.merge(dotenter)
            .transition(transition)
            .attr('cy', d => yScale(+(d.value)))
    }

    /**
     * submit the selected date
     * @name SubmitDate
     * @param null
     * @return null
     */
    function SubmitDate() {
        console.log('==============' + 'SubmitDate' + '===================')
        console.log(app.selectYear, app.selectMonth, app.selectDay)

        var validYear = app.selectYear != "" && app.selectYear != undefined
        validMonth = app.selectMonth != "" && app.selectMonth != undefined
        var validDay = app.selectDay != "" && app.selectDay != undefined
        app.queryTime = "xxx"
        
        if(validYear != true){
            app.undefinedDate = true
        }
        else if(validDay == true && validMonth != true){
            app.undefinedDate = true
        }

        if(app.selectYear == 2021 && validMonth == true){
            if(app.selectMonth > 4){
                app.invalidDate = true
                return
            }
            else if(app.selectMonth == 4 && validDay == true){
                if(app.selectDay > 19){
                    app.invalidDate = true
                    return
                }
            }
        }
        else if(app.selectYear == 2014 && validMonth == true){
            if(app.selectMonth < 5){
                app.invalidDate = true
                return
            }
            else if(app.selectMonth == 5 && validDay == true){
                if(app.selectDay < 14){
                    app.invalidDate = true
                    return
                }
            }
        }

        // validate the regular date
        if(validMonth == true){
            if((app.selectMonth == 4 || app.selectMonth == 6 || app.selectMonth == 9 || app.selectMonth == 11) && validDay == true){
                if(app.selectDay > 30){
                    app.invalidDate = true
                    return
                }
            }
            else if(app.selectMonth == 2 && validDay == true){
                if(app.selectYear == 2016 || app.selectYear == 2020){
                    if(app.selectDay > 29){
                        app.invalidDate = true
                        return
                    }
                }
                else{
                    if(app.selectDay > 28){
                        app.invalidDate = true
                        return
                    }
                }
            }
        }

        // generate the time string
        if(validYear == true){
            app.timeRange = 'year'
            app.queryTime = app.selectYear.toString() + "年"
            if(validMonth == true){
                app.timeRange = 'month'
                app.queryTime = app.queryTime + app.selectMonth.toString() + "月"
                if(validDay == true){
                    app.timeRange = 'day'
                    app.queryTime = app.queryTime + app.selectDay.toString() + "日"
                }
            }
        }

        // render the scatter map
        if(validDay == true){
            RenderScatterPlot(app.selectTarget, 'day', app.selectYear, app.selectMonth, app.selectDay)
            myTime = 'day'
        }
        else if(validMonth == true){
            RenderScatterPlot(app.selectTarget, 'month', app.selectYear, app.selectMonth, app.selectDay)
            myTime = 'month'
        }
        else{
            RenderScatterPlot(app.selectTarget, 'year', app.selectYear, app.selectMonth, app.selectDay)
            myTime = 'year'
        }
        myTarget = app.selectTarget
        myYear = app.selectYear
        myMonth = app.selectMonth
        myDay = app.selectDay
    }

    /**
     * change the quality rank best or worse (Histogram)
     * @name ChangeQualityRank
     * @param null
     * @return null
     */
    function ChangeQualityRank() {
        console.log('==============' + 'ChangeQualityRank' + '===================')
        if(app.qualityRank == "AQI最好"){
            console.log('==============' + '最好' + '===================')
            // to do
            DrawRating('#rankSvg', 'AQI_seasonmean_D3.csv', app.qualityRank)
        }
        else{
            console.log('==============' + '最差' + '===================')
            // to do
            DrawRating('#rankSvg', 'AQI_seasonmean_D3.csv', app.qualityRank)
        }
    }

    /**
     * change the quality distribution best or worse (Pie chart)
     * @name ChangeQualityDistribution
     * @param null
     * @return null
     */
     function ChangeQualityDistribution() {
        console.log('==============' + 'ChangeQualityDistribution' + '===================')
        if(app.qualityRank == "AQI最好"){
            console.log('==============' + '最好' + '===================')
            // to do
        }
        else{
            console.log('==============' + '最差' + '===================')
            // to do
        }
    }

    /**
     * change the quality region 
     * @name ChangeRegion
     * @param null
     * @return null
     */
     function ChangeRegion() {
        console.log('==============' + 'ChangeRegion' + '===================')
        console.log('当前选择的展示区域是', app.selectRegion)
        // to do
        DrawRating('#rankSvgLoc', 'AQI_seasonmean_'+app.selectRegion+'_forD3.csv', 'AQI最差')
    }
    

  </script>

  <style scoped>
      .timeSelection {
            width:250px;
            margin-left: 20px;
            margin-top: 20px;
      }

      #content1 {
            display: flex;
      }

      #test {
            display: block;
      }

      .cardBox {
            display: inline;
            width: 280px;
      }

      .cardDiv {
            display: flex;
            height: 150px;
      }

      .cardDiv2 {
            display: flex;
            height: 360px;
      }

      .ivu-select {
            margin-bottom: 10px;
      }

      .ivu-btn {
            margin-top: 20px;
            float: right;
      }

      #mapSvg {
          margin-top: 10px;
          margin-right: 10px;
      }

      .plotSelection {
            width:250px;
            margin-left: 20px;
            margin-top: 20px;
      }

      #content2 {
            display: flex;
      }

      .plotSvg {
            width: 1000px;
            height: 300px;
      }

      .backButton {
            margin-top: 215px;
            margin-left: 10px;
      }

      .rankSelection{
            width:250px;
            margin-left: 20px;
            margin-top: 20px;
      }

      .regionSelection{
            width:250px;
            margin-left: 20px;
            margin-top: 20px;
      }

      .distributionSelection{
            width:250px;
            margin-left: 20px;
            margin-top: 20px;
      }

      p {
            font-family: "Microsoft YaHei";
            font-size: 15px;
      }

      .ivu-menu-item {
        font-size: 17px;
      }

      div, li, label, button, .ivu-radio-wrapper{
            /* font-family: "华文细黑"; */
            font-family: "Microsoft YaHei";
            font-size: 15px;
      }

      /* .scatterText {
            font-family: "Microsoft YaHei";
      } */

      i {
            font-family: "Microsoft YaHei";
            font-size: 20px;
      }

      .title {
        font-family: "Microsoft YaHei";
        font-size: 12px;
      }
  </style>

</body>
</html>