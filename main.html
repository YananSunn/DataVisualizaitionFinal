<html>
<head>
    <meta charset="utf-8">
    <title>全国天气质量可视化</title>
    <script src="d3.min.js"></script>
    <script src="d3-v6-tip.js"></script>
    <link rel="stylesheet" href="d3-tip.css">
    <link rel="stylesheet" type="text/css" href="http://unpkg.com/view-design/dist/styles/iview.css">
    <script type="text/javascript" src="http://vuejs.org/js/vue.min.js"></script>
    <script type="text/javascript" src="http://unpkg.com/view-design/dist/iview.min.js"></script>
    <script src="ra2.js"></script>
    <script src="RadarChart.js"></script>
</head>
<body>
<div id="app">
    <i-menu mode="horizontal" :theme="theme1" active-name="1" @on-select="ChangeMenu">
        <Menu-Item name="1">
            <Icon type="ios-paper"></Icon>
            全国空气质量数据
        </Menu-Item>
        <Menu-Item name="2">
            <Icon type="ios-timer"></Icon>
            城市历史空气质量数据
        </Menu-Item>
        <Menu-Item name="3" v-on:click=>
            <Icon type="ios-people"></Icon>
            城市空气质量排名
        </Menu-Item>
        <Menu-Item name="4">
            <Icon type="ios-stats"></Icon>
            地区AQI排名
        </Menu-Item>
        <Menu-Item name="5">
            <Icon type="ios-map"></Icon>
            地域分布
        </Menu-Item>
    </i-menu>
    <div id="content1" v-show="menuId == '1'">
        <div class="cardBox">
            <div class="cardDiv">
                <Card class="timeSelection" >
                    <p slot="title">
                        <Icon type="ios-warning-outline"></Icon>
                        注意事项
                    </p>
                    <ul>
                        <div>
                            <p>可查询时间范围为 2014年5月14日 至 2021年4月19日。</p>
                            <br>
                        </div>
                    </ul>
                </Card>
            </div>
            <div class="cardDiv">
                <Card class="timeSelection" >
                    <p slot="title">
                        <Icon type="ios-apps-outline"></Icon>
                        选择查询指标
                    </p>
                    <ul>
                        <div>
                            <i-select v-model="selectTarget" placeholder="请选择指标" style="width:200px">
                                <i-option v-for="item in targetList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                            </i-select>
                            
                            <!-- <i-button @click="SubmitDate">展示</i-button>
                            <Modal v-model="invalidDate" title="警告">您输入了不合法的日期，请重试</Modal>
                            <Modal v-model="undefinedDate" title="警告">您未选择确定的日期</Modal> -->
                        </div>
                    </ul>
                </Card>
            </div>
            <div class="cardDiv2">
                <Card class="timeSelection" >
                    <p slot="title">
                        <Icon type="ios-calendar-outline"></Icon>
                        选择查询日期
                    </p>
                    <ul>
                        <div>
                            <p>您当前查询的时间为 <b>{{queryTime}}</b>。</p>
                            <br>
                            <i-select v-model="selectYear" placeholder="请选择年" clearable style="width:200px">
                                <i-option v-for="item in yearList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                            </i-select>
                            <i-select v-model="selectMonth" placeholder="请选择月" clearable style="width:200px">
                                <i-option v-for="item in monthList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                            </i-select>
                            <i-select v-model="selectDay" placeholder="请选择日" clearable style="width:200px">
                                <i-option v-for="item in dayList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                            </i-select>
                            <i-button @click="SubmitDate">展示</i-button>
                            <Modal v-model="invalidDate" title="警告">您输入了不合法的日期，请重试</Modal>
                            <Modal v-model="undefinedDate" title="警告">您未选择确定的日期</Modal>
                        </div>
                    </ul>
                </Card>
            </div>
        </div>
        <svg width="1000" height="700" id="mapSvg" class="svgs" style='display: block;'></svg>
        <i-button id="closeRadar" type="info" shape="circle" size="middle" v-show="closeRadar" @click="CloseRadarPlot">
            <p>关闭雷达图</p>
        </i-button>
    </div>
    <div id="content2" v-show="menuId == '2'">
        <div class="cardBox">
            <div class="cardDiv">
                <Card class="plotSelection" >
                    <p slot="title">
                        <Icon type="ios-information-circle-outline"></Icon>
                        提示
                    </p>
                    <ul>
                        <div>
                            <p>当前显示的城市为<b>{{selectCity}}</b>。</p>
                            <br>
                        </div>
                    </ul>
                </Card>
            </div>
            <div class="cardDiv">
                <Card class="plotSelection" >
                    <p slot="title">
                        <Icon type="ios-browsers-outline"></Icon>
                        选择展示的图
                    </p>
                    <ul>
                        <div>
                            <Radio-Group v-model="selectPlot" @on-change="ChangePlot">
                                <Radio label="散点图/折线图"></Radio>
                                <Radio label="箱线图"></Radio>
                            </Radio-Group>
                        </div>
                    </ul>
                </Card>
            </div>
            <div class="cardDiv" v-show="showScaleCard">
                <Card class="plotSelection" >
                    <p slot="title">
                        <Icon type="ios-crop-outline"></Icon>
                        选择散点图的展示规模
                    </p>
                    <ul>
                        <div>
                            <Radio-Group v-model="selectScale" @on-change="ChangePlot">
                                <Radio label="全局"></Radio>
                                <Radio label="局部"></Radio>
                            </Radio-Group>
                        </div>
                    </ul>
                </Card>
            </div>
         </div>
        
        <div id="plots">
            <div id="plotAQI">
                <svg class="plotSvg" width="1200" height="300" id="plotAQISvg" class="svgs"></svg>
            </div>
            <div id="plotPM25">
                <svg class="plotSvg" width="1200" height="300" id="plotPM25Svg" class="svgs"></svg>
            </div>
            <div id="plotPM10">
                <svg class="plotSvg" width="1200" height="300" id="plotPM10Svg" class="svgs"></svg>
            </div>
            <div id="plotSO2">
                <svg class="plotSvg" width="1200" height="300" id="plotSO2Svg" class="svgs"></svg>
            </div>
            <div id="plotO3">
                <svg class="plotSvg" width="1200" height="300" id="plotO3Svg" class="svgs"></svg>
            </div>
            <div id="plotCO">
                <svg class="plotSvg" width="1200" height="300" id="plotCOSvg" class="svgs"></svg>
            </div>
        </div>
    </div>
    <div v-show="menuId == '3'">
        <div class="cardBox">
            <div class="cardDiv">
                <Card class="rankSelection" >
                    <p slot="title">
                        <Icon type="ios-stats-outline"></Icon>
                        选择排名指标
                    </p>
                    <ul>
                        <div>
                            <Radio-Group v-model="qualityRank" @on-change="ChangeQualityRank">
                                <Radio label="AQI最好"></Radio>
                                <Radio label="AQI最差"></Radio>
                            </Radio-Group>
                        </div>
                    </ul>
                </Card>
            </div>
        </div>
        <svg width="1400" height="700" id="rankSvg" class="svgs"></svg>
    </div>
    <div v-show="menuId == '4'">
        <div class="cardBox">
            <div class="cardDiv">
                <Card class="regionSelection" >
                    <p slot="title">
                        <Icon type="ios-map-outline"></Icon>
                        选择排名地区
                    </p>
                    <ul>
                        <div>
                            <i-select v-model="selectRegion" placeholder="请选择地区" clearable @on-change="ChangeRegion" style="width:200px">
                                <i-option v-for="item in regionList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                            </i-select>
                        </div>
                    </ul>
                </Card>
            </div>
        </div>
    </div>
    <div v-show="menuId == '5'">
        <div class="cardBox">
            <div class="cardDiv">
                <Card class="distributionSelection" >
                    <p slot="title">
                        <Icon type="ios-stats-outline"></Icon>
                        选择查看分布的指标
                    </p>
                    <ul>
                        <div>
                            <Radio-Group v-model="qualityDistribution" @on-change="ChangeQualityDistribution">
                                <Radio label="AQI最好"></Radio>
                                <Radio label="AQI最差"></Radio>
                            </Radio-Group>
                        </div>
                    </ul>
                </Card>
            </div>
        </div>
        
    </div>    
    
</div>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            theme1: 'light',
            menuId: '1',

            selectYear: '',
            yearList: [],
            selectMonth: '',
            monthList: [],
            selectDay: '',
            dayList: [],

            timeRange: '',

            invalidDate: false,
            undefinedDate: false,
            closeRadar: false,

            queryTime: "xxx",

            selectTarget: 'AQI',
            targetList: [
                {
                    value: 'AQI',
                    label: 'AQI'
                },
                {
                    value: 'PM2.5',
                    label: 'PM2.5'
                },
                {
                    value: 'PM10',
                    label: 'PM10'
                },
                {
                    value: 'SO2',
                    label: 'SO2'
                },
                {
                    value: 'O3',
                    label: 'O3'
                },
                {
                    value: 'CO',
                    label: 'CO'
                }
            ],

            selectPlot: '散点图/折线图',
            selectScale: '全局',
            selectCity: '北京',
            showScaleCard: true,
            AQIDayMean: [],
            PM25DayMean: [],
            PM10DayMean: [],
            SO2DayMean: [],
            O3DayMean: [],
            CODayMean: [],
            
            qualityRank: 'AQI最好',

            selectRegion: '',
            regionList:[
                {
                    value: '华中',
                    label: '华中'
                },
                {
                    value: '华北',
                    label: '华北'
                },
                {
                    value: '华东',
                    label: '华东'
                },
                {
                    value: '华南',
                    label: '华南'
                },
                {
                    value: '西北',
                    label: '西北'
                },
                {
                    value: '东北',
                    label: '东北'
                },
                {
                    value: '西南',
                    label: '西南'
                }
            ],

            qualityDistribution: 'AQI最好',

            projection: d3.geoMercator()
        },
        beforeMount () {
            console.log('==============' + 'beforeMount' + '===================')
            for(var i = 2014; i < 2022; i++){
                this.yearList.push({
                    value: i,
                    label: i.toString() + "年"
                })
            }
            // console.log(this.yearList)

            for(var i = 1; i < 13; i++){
                this.monthList.push({
                    value: i,
                    label: i.toString() + "月",
                })
            }
            // console.log(this.monthList)

            for(var i = 1; i < 32; i++){
                this.dayList.push({
                    value: i,
                    label: i.toString() + "日"
                })
            }
            // console.log(this.dayList)

            for(var i = 1400025600000; i <= 1618790400000; i = i + 86400000){
                this.AQIDayMean.push({
                    date: new Date(i),
                    value: 0
                })
                this.PM25DayMean.push({
                    date: new Date(i),
                    value: 0
                })
                this.PM10DayMean.push({
                    date: new Date(i),
                    value: 0
                })
                this.SO2DayMean.push({
                    date: new Date(i),
                    value: 0
                })
                this.O3DayMean.push({
                    date: new Date(i),
                    value: 0
                })
                this.CODayMean.push({
                    date: new Date(i),
                    value: 0
                })
            }
        },
        mounted () {
            console.log('==============' + 'mounted' + '===================')
            RenderMap()
        },
        methods: {
            // show: function () {
            //     this.visible = true;
            // }
            handleSpinCustom () {
                this.$Spin.show({
                    render: (h) => {
                        return h('div', [
                            h('Icon', {
                                'class': 'demo-spin-icon-load',
                                props: {
                                    type: 'ios-loading',
                                    size: 18
                                }
                            }),
                            h('div', '正在加载，请稍后......')
                        ])
                    }
                });
                setTimeout(() => {
                    this.$Spin.hide();
                }, 3000);
            }
        }
    })

    const circleRadius = 7
    var zoomScale = 1
    var myTarget
    var myTime = ''
    var myYear
    var myMonth
    var myDay
    var highlightedYear = [];
    var highlightedMonth = [];

    const mapColors = d3.scaleOrdinal(d3.schemeBlues[9])

    /**
     * change the open menu item and control badge to remind the new messages
     * @name ChangeMenu
     * @param name<string>:the name of the selected submenu
     * @return null
     */
     function ChangeMenu(name) {
      app.menuId = name;
      if(name == '2'){
        ReadHistoryData()
        ChangePlot()
        app.handleSpinCustom()
      }
    }

    /**
     * close the radar plot
     * @name CloseRadarPlot
     * @param null
     * @return null
     */
     function CloseRadarPlot(){
        var mapSvg = d3.select('#mapSvg')
        mapSvg.selectAll('#chart').remove()
        app.closeRadar = false
    }


    /**
     * render the map in the first part
     * @name RenderMap
     * @param null
     * @return null
     */
    function RenderMap() {
        const mapSvg = d3.select('#mapSvg');
        const width = mapSvg.attr('width');
        const height = mapSvg.attr('height');
        const margin = { top: 60, right: 0, bottom: 0, left: 0 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;
        const mainGroup = mapSvg.append('g')
        .attr('id', 'mainGroup')
        .attr('transform', `translate(${margin.left}, ${margin.top})`);
        const tip = d3.tip().html((event, d) => d.properties.name);
        mapSvg.call(tip);
        tip.attr('class', 'd3-tip');

        const zoom = d3.zoom()
            .scaleExtent([1, 20])
            .on("zoom", (event, d) => {
                mainGroup.attr("transform", event.transform);
                zoomScale = event.transform.k;
                console.log(zoomScale);
                if (myTime != '')
                    RenderScatterPlot(myTarget, myTime, myYear, myMonth, myDay)
            })

        mapSvg.call(zoom);
        // mapSvg.call(zoom.transform, d3.zoomIdentity.translate(100, 100));

        d3.json('Data/china.json').then(async data => {
            //const projection = d3.geoNaturalEarth1();
            //const projection = d3.geoMercator();
            app.projection.fitSize([innerWidth, innerHeight], data);
            const path = d3.geoPath().projection(app.projection);
            mainGroup.selectAll('path').data(data.features).join('path')
                .attr('stroke', 'white')
                .attr('fill', function(d, i){
                    // return mapColors[i]
                    var index = (i%8)+2
                    if(i == 0){
                        mapColors(0)
                    }
                    else if(i == 8){
                        mapColors(8)
                    }
                    return mapColors(index)
                })
                .attr('opacity', 0.8)
                .attr('d', path)
                .attr('id', d => d.properties.name)
                .on('mouseover', tip.show)
                .on('mouseout', tip.hide);            
        });
    }

    /**
     * render the scatter plot of the specific time range
     * @name RenderScatterPlot
     * @param time<string>:the name of the input csv
     * @return null
     */
    function RenderScatterPlot(target, time, year, month, day) {
        console.log('==============' + 'RenderScatterPlot' + '===================')

        // const colorMap = [
        //     '#7FFF00',  // 0-50
        //     '#FFD700',  // 50-100
        //     '#FF8C00',  // 100-150
        //     '#FF0000',  // 150-200
        //     '#B22222',  // 200-300
        //     '#800000',  // 300+
        // ]
        const colorMap = [
            '#9BE441',  // 0-50
            '#FACF39',  // 50-100
            '#F89049',  // 100-150
            '#FF5555',  // 150-200
            '#A264BF',  // 200-300
            '#75365A',  // 300+
        ]

        const rangeMap = [
            [ // AQI
                50, 100, 150, 200, 300
            ],
            [ // PM2.5
                20, 50, 80, 120, 150
            ],
            [ // PM10
                50, 100, 150, 200, 300
            ],
            [ // SO2
                10, 30, 50, 70, 90
            ],
            [ // O3
                20, 40, 60, 80, 120,
            ],
            [ // CO
                0.5, 1, 2, 3, 4
            ]
        ]

        const maxAQI = 300
        const maxPM25 = 150
        const maxPM10 = 300
        const maxSO2 = 100
        const maxO3 = 100
        const maxCO = 3


        // console.log(target, time, year, month, day)
        var filename = 'Data_v2/' + target + '_' + time + 'mean.csv'
        console.log('Open file name', filename)

        d3.csv(filename).then(async data => {

            var renderData
            var renderDate
            
            if(time == 'day') {
                renderDate = year.toString() + month.toString().padStart(2, '0') + day.toString().padStart(2, '0')
            }
            else if(time == 'month') {
                renderDate = year.toString() + month.toString().padStart(2, '0')
            }
            else {
                renderDate = year.toString()
            }

            // console.log('renderDate', renderDate)
            
            for(var i = 0; i < data.length; i++){
                if(data[i][''] == renderDate){
                    // console.log('find date', data[i])
                    renderData = data[i]
                    break
                }
            }
            // console.log('renderData', renderData)            

            var locations = []
            var targetValue = []
            var cityName = []
            
            d3.csv('Data/citynamewithlocation.csv').then(locationData =>{
                // console.log('locationData', locationData)
                for(var key in renderData){
                    locationData.map(e=>{
                        if(key == e.City){
                            // console.log('find city', e)
                            var loc = new Array(parseFloat(e.Longtitude), parseFloat(e.Latitude))
                            locations.push(loc)
                            targetValue.push({
                                value: parseFloat(renderData[key]),
                                rate: e.Rate
                            })
                            cityName.push(key)
                        }
                    })
                }

                mainGroup = d3.select('#mainGroup')
                mainGroup.selectAll('#scatterCircle').remove()
                mainGroup.selectAll('.scatterText').remove()

                mainGroup.selectAll('circle')
                .data(locations)
                .enter().append('circle')
                .attr('cx', function(d) {
                    return app.projection(d)[0]
                })
                .attr('cy', function(d) {
                    return app.projection(d)[1]
                })
                .attr('opacity', 0.85)
                .attr('id', 'scatterCircle')
                .data(targetValue)
                .attr('display', function(d) {
                    if(d.value == -1) {
                        return 'none'
                    }
                    else {
                        if(zoomScale < 8)
                        {
                            if (d.rate == 3)
                                return 'none';
                        }
                    }
                })
                .attr('r', function(d){
                    if(zoomScale < 2){
                        return (circleRadius*3/4)/Math.sqrt(zoomScale)
                    }
                    else if(zoomScale < 4){
                        return (circleRadius*7/8)/Math.sqrt(zoomScale)
                    }
                    else{
                        return circleRadius/Math.sqrt(zoomScale)
                    }
                })
                .attr('fill', function(d) {
                    var rangeMapIndex
                    switch (target) {
                        case 'AQI':
                            rangeMapIndex = 0
                            break;
                        case 'PM2.5':
                            rangeMapIndex = 1
                            break;
                        case 'PM10':
                            rangeMapIndex = 2
                            break;
                        case 'SO2':
                            rangeMapIndex = 3
                            break;
                        case 'O3':
                            rangeMapIndex = 4
                            break;
                        case 'CO':
                            rangeMapIndex = 5
                            break;
                        default:
                            break;
                    }
                    if(d.value < rangeMap[rangeMapIndex][0]){
                        return colorMap[0]
                    }
                    else if(d.value < rangeMap[rangeMapIndex][1]){
                        return colorMap[1]
                    }
                    else if(d.value < rangeMap[rangeMapIndex][2]){
                        return colorMap[2]
                    }
                    else if(d.value < rangeMap[rangeMapIndex][3]){
                        return colorMap[3]
                    }
                    else if(d.value < rangeMap[rangeMapIndex][4]){
                        return colorMap[4]
                    }
                    else {
                        return colorMap[5]
                    }
                })
                .attr('stroke', 'black')
                .attr('stroke-width', 0.2)
                .data(cityName)
                .on('mouseover', (event, d) => {
                    mapSvg = d3.select('#mapSvg')
                    mapSvg.selectAll('#chart').remove()

                    app.closeRadar = true

                    var radarChart = mapSvg.append('g')
                    .attr('id', 'chart')
                    .attr('transform', function(d){
                        return `translate(${event.clientX - 275}, ${event.clientY - 70})`
                    })
                    .append("rect")
                    .attr('width', '180')
                    .attr('height', '180')
                    .attr("rx", 50)
                    .attr("fill", "white")
                    .attr('opacity', 0.8);           
                    
                    var AQIFilename = 'Data_v2/AQI_' + time + 'mean.csv'
                    var AQIValue = 0
                    d3.csv(AQIFilename).then(AQIData =>{
                        // console.log("RadarPlot AQI", AQIData)
                        var selectRow
                        for(var i = 0; i < AQIData.length; i++){
                            if(AQIData[i][''] == renderDate){
                                selectRow = AQIData[i]
                                break
                            }
                        }
                        AQIValue = selectRow[d]

                        var PM25Filename = 'Data_v2/PM2.5_' + time + 'mean.csv'
                        var PM25Value = 0
                        d3.csv(PM25Filename).then(PM25Data =>{
                            // console.log("RadarPlot PM25", PM25Data)
                            var selectRow
                            for(var i = 0; i < PM25Data.length; i++){
                                if(PM25Data[i][''] == renderDate){
                                    selectRow = PM25Data[i]
                                    break
                                }
                            }
                            PM25Value = selectRow[d]

                            var PM10Filename = 'Data_v2/PM10_' + time + 'mean.csv'
                            var PM10Value = 0
                            d3.csv(PM10Filename).then(PM10Data =>{
                                // console.log("RadarPlot PM10", PM10Data)
                                var selectRow
                                for(var i = 0; i < PM10Data.length; i++){
                                    if(PM10Data[i][''] == renderDate){
                                        selectRow = PM10Data[i]
                                        break
                                    }
                                }
                                PM10Value = selectRow[d]

                                var SO2Filename = 'Data_v2/SO2_' + time + 'mean.csv'
                                var SO2Value = 0
                                d3.csv(SO2Filename).then(SO2Data =>{
                                    // console.log("RadarPlot SO2", SO2Data)
                                    var selectRow
                                    for(var i = 0; i < SO2Data.length; i++){
                                        if(SO2Data[i][''] == renderDate){
                                            selectRow = SO2Data[i]
                                            break
                                        }
                                    }
                                    SO2Value = selectRow[d]

                                    var O3Filename = 'Data_v2/O3_' + time + 'mean.csv'
                                    var O3Value = 0
                                    d3.csv(O3Filename).then(O3Data =>{
                                        // console.log("RadarPlot O3", O3Data)
                                        var selectRow
                                        for(var i = 0; i < O3Data.length; i++){
                                            if(O3Data[i][''] == renderDate){
                                                selectRow = O3Data[i]
                                                break
                                            }
                                        }
                                        O3Value = selectRow[d]

                                        var COFilename = 'Data_v2/CO_' + time + 'mean.csv'
                                        var COValue = 0
                                        d3.csv(COFilename).then(COData =>{
                                            // console.log("RadarPlot CO", COData)
                                            var selectRow
                                            for(var i = 0; i < COData.length; i++){
                                                if(COData[i][''] == renderDate){
                                                    selectRow = COData[i]
                                                    break
                                                }
                                            }
                                            COValue = selectRow[d]

                                            // console.log("Value", AQIValue, PM25Value, PM10Value, SO2Value, O3Value, COValue)

                                            var radarPlotData = []
                                            radarPlotData.push(renderDate)
                                            radarPlotData.push(AQIValue/maxAQI)
                                            radarPlotData.push(PM25Value/maxPM25)
                                            radarPlotData.push(PM10Value/maxPM10)
                                            radarPlotData.push(SO2Value/maxSO2)
                                            radarPlotData.push(O3Value/maxO3)
                                            radarPlotData.push(COValue/maxCO)
                                            
                                            // console.log("render data", radarPlotData)
                                            radar('#chart', 'type.csv', radarPlotData, d);
                                        });
                                    });
                                });
                            });
                        });

                    });
                })
                .on('click', (event, d)=>{
                    app.selectCity = d
                    ReadHistoryData()
                    app.menuId = '2'
                    app.handleSpinCustom()
                })                
                

                mainGroup.selectAll('text')
                .data(locations)
                .enter()
                .append('text')
                .attr('font-size', 0.55/Math.sqrt(zoomScale)+'em')
                // .attr('fill', '#FFFFFFF')
                .attr('text-anchor', 'middle')
                .attr('transform', function(d){
                    return `translate(${app.projection(d)[0] - (circleRadius/Math.sqrt(zoomScale))*1/16}, ${app.projection(d)[1] + (circleRadius/Math.sqrt(zoomScale))*7/16})`
                })
                .attr('class', 'scatterText')
                .data(targetValue)
                .attr('display', function(d) {
                    if(d.value == -1) {
                        return 'none'
                    }
                    else {
                        if(zoomScale < 4)
                        {
                            return 'none';
                        }
                        else if(zoomScale < 8)
                        {
                            if (d.rate == 3)
                                return 'none';
                        }
                        else {
                            return 'flex'
                        }
                    }
                })
                .attr('disabled', true)
                .text(function(d){
                    switch (target) {
                        case 'AQI':
                            return d.value.toFixed(0)
                            break;
                        case 'PM2.5':
                            return d.value.toFixed(0)   
                            break;
                        case 'PM10':
                            return d.value.toFixed(0)
                            break;
                        case 'SO2':
                            return d.value.toFixed(0)
                            break;
                        case 'O3':
                            return d.value.toFixed(0)
                            break;
                        case 'CO':
                            return d.value.toFixed(1)
                            break;
                        default:
                            break;
                    }
                })
            });
        });
      
    }

     /**
     * read history data for scatter plot, box plot and line plot
     * @name ReadHistoryData
     * @param null
     * @return null
     */
    function ReadHistoryData(){
        console.log("ReadHistoryData()", app.selectCity)
        d3.csv('Data_v2/AQI_daymean.csv').then(data =>{
            // console.log('AQI data', data)
            for(var i = 0; i < app.AQIDayMean.length; i++){
                app.AQIDayMean[i].value= data[i][app.selectCity]
            }

            d3.csv('Data_v2/PM2.5_daymean.csv').then(data =>{
                for(var i = 0; i < app.PM25DayMean.length; i++){
                    app.PM25DayMean[i].value= data[i][app.selectCity]
                }

                d3.csv('Data_v2/PM10_daymean.csv').then(data =>{
                    for(var i = 0; i < app.PM10DayMean.length; i++){
                        app.PM10DayMean[i].value= data[i][app.selectCity]
                    }

                    d3.csv('Data_v2/SO2_daymean.csv').then(data =>{
                        for(var i = 0; i < app.SO2DayMean.length; i++){
                            app.SO2DayMean[i].value= data[i][app.selectCity]
                        }

                        d3.csv('Data_v2/O3_daymean.csv').then(data =>{
                            for(var i = 0; i < app.O3DayMean.length; i++){
                                app.O3DayMean[i].value= data[i][app.selectCity]
                            }

                            d3.csv('Data_v2/CO_daymean.csv').then(data =>{
                                for(var i = 0; i < app.CODayMean.length; i++){
                                    app.CODayMean[i].value= data[i][app.selectCity]
                                }

                                ChangePlot()
                            })
                        })
                    })
                })
            })
        })

        
    }

    /**
     * change the plot category
     * @name ChangePlot
     * @param null
     * @return null
     */
    function ChangePlot() {
        console.log('==============' + 'ChangePlot' + '===================')
        if(app.selectPlot == '散点图/折线图'){
            app.showScaleCard = true
            d3.selectAll('.plotg').remove()
            // draw scatter plot
            DrawScatterPlot('#plotAQISvg', 'AQI')
            DrawScatterPlot('#plotPM25Svg', 'PM2.5')
            DrawScatterPlot('#plotPM10Svg', 'PM10')
            DrawScatterPlot('#plotSO2Svg', 'SO2')
            DrawScatterPlot('#plotO3Svg', 'O3')
            DrawScatterPlot('#plotCOSvg', 'CO')
        }
        else{
            app.showScaleCard = false
            // draw box plot
            d3.selectAll('.plotg').remove()
        }
    }

    /**
     * draw scatter plot of specified target
     * @name DrawScatterPlot
     * @param divid<string> the id of svg; target<string> the name of target
     * @return null
     */
    function DrawScatterPlot(divid, target){
        var targetData
        var yLabel
        var scaleDomain
        var colorIndex
        const domainRange = [
            [520, 500, 700, 150, 200, 10],
            [400, 300, 300, 100, 150, 5]
        ]
        var domainRangeIndex
        switch (app.selectScale) {
            case '全局':
                domainRangeIndex = 0
                break;
            case '局部':
                domainRangeIndex = 1
                break;
            default:
                break;
        }

        switch (target) {
            case 'AQI':
                targetData = app.AQIDayMean
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][0]
                colorIndex = 0
                break;
            case 'PM2.5':
                targetData = app.PM25DayMean
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][1]
                colorIndex = 1
                break;
            case 'PM10':
                targetData = app.PM10DayMean
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][2]
                colorIndex = 2
                break;
            case 'SO2':
                targetData = app.SO2DayMean
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][3]
                colorIndex = 3
                break;
            case 'O3':
                targetData = app.O3DayMean
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][4]
                colorIndex = 0
                break;
            case 'CO':
                targetData = app.CODayMean
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][5]
                colorIndex = 1
                break;
            default:
                break;
        }


        const xValue = d => d.date;
        const yValue = d => d.value;
        
        let xScale, yScale;
        const xBarValue = (datum) => {return datum.date};
        const yBarValue = (datum) => {return datum.value};
        const xAxisLabel = 'date';
        const yAxisLabel = yLabel;

        let gg = d3.select(divid)
        let g = gg.append('g')
        .attr('class', 'plotg')
        .attr('transform', `translate(${-100}, ${0})`);

        var innerHeight = gg.attr('height')
        var innerWidth = gg.attr('width')

        
        xScale = d3.scaleTime()
        .domain([new Date(2014, 3, 14), new Date(2021, 4, 19)])
        .range([0, innerWidth-250])
        
        yScale = d3.scaleLinear()
        .domain([0, scaleDomain].reverse())
        .range([0, innerHeight-120])
        

        const xAxisMethod = d3.axisBottom(xScale).ticks(10);
        const yAxisMethod = d3.axisLeft(yScale).ticks(5);
        const xAxisGroup = g.append('g').call(xAxisMethod)
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');
        // xAxisGroup.append('text')
        // .attr('font-size', '1em')
        // .attr('y', 60)
        // .attr('x', innerWidth / 2 - 100)
        // .attr('fill', '#504f4f')
        // .text(xAxisLabel)
        // .attr('text-anchor', 'middle') 

        const yAxisGroup = g.append('g').call(yAxisMethod)
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');
        yAxisGroup.append('text')
        .attr('font-size', '1em')
        .attr("font-family", 'Microsoft YaHei') 
        .attr('transform', `rotate(-90)`)
        .attr('x', -(innerHeight - 100) / 2)
        .attr('y', -70)
        .attr('fill', '#504f4f')
        .text(yAxisLabel)
        .attr('text-anchor', 'middle') 

        xAxisGroup.attr('transform', `translate(${200}, ${innerHeight-70})`);
        yAxisGroup.attr('transform', `translate(${200}, ${50})`);

        var dates = [
            [new Date(2014, 3, 14), new Date(2015, 0, 1)],
            [new Date(2015, 0, 1), new Date(2016, 0, 1)],
            [new Date(2016, 0, 1), new Date(2017, 0, 1)],
            [new Date(2017, 0, 1), new Date(2018, 0, 1)],
            [new Date(2018, 0, 1), new Date(2019, 0, 1)],
            [new Date(2019, 0, 1), new Date(2020, 0, 1)],
            [new Date(2020, 0, 1), new Date(2021, 0, 1)],
            [new Date(2021, 0, 1), new Date(2021, 4, 19)]
        ];
        
        g.selectAll(".dot")
        .data(targetData)
        .enter().append("circle") // Uses the enter().append() method
        .attr("class", "dot") // Assign a class for styling
        .attr("cx", function(d, i) { 
            return xScale(d.date) 
        })
        .attr("cy", function(d) { 
            return yScale(d.value) 
        })
        .attr("r", 2)
        .attr('transform', `translate(${200}, ${50})`)
        .attr('display', function(d){
            if(d.value == -1.0){
                return 'none'
            }
            return 'block'
        })
        .attr('fill', function(d){
            return mapColors(8-colorIndex)
        })

        g.selectAll(".highlightarea").data(dates).join('rect')
            .attr('class', 'highlightarea')
            .attr('x', d => xScale(d[0]))
            .attr('y', 0)
            .attr('width', d => xScale(d[1])-xScale(d[0]))
            .attr('height', innerHeight-120)
            .attr('fill', '#DCDCDC')
            .attr('opacity', 0)
            .attr('transform', `translate(${200}, ${50})`)
            .on('mouseover', (event, d) => {
                d3.select(event.currentTarget).attr('opacity', 0.3);
                highlightedYear = d;
                g.selectAll(".dot").data(targetData)
                .attr('fill', function(d){
                    if (d.date >= highlightedYear[0] && d.date < highlightedYear[1])
                        return 'purple';
                    else
                        return mapColors(8-colorIndex);
                })
            })
            .on('mouseout', (event, d) => {
                d3.select(event.currentTarget).attr('opacity', 0);
                hightlightedYear = [];
                g.selectAll(".dot").data(targetData)
                .attr('fill', function(d){
                    return mapColors(8-colorIndex);
                })
            })
            .on('click', (event, d) => {
                var targetDataYear = [];
                targetData.forEach(datum => { 
                    if (datum.date >= d[0] && datum.date < d[1])
                        targetDataYear.push(datum);
                })
                g.remove();
                DrawScatterPlotYear(divid, target, targetDataYear, d);
                console.log(targetDataYear);
            });
    }

    /**
     * draw scatter plot of specified target
     * @name DrawScatterPlot
     * @param divid<string> the id of svg; target<string> the name of target
     * @return null
     */
     async function DrawScatterPlotYear(divid, target, targetDataYear, year){
        var yLabel
        var scaleDomain
        var colorIndex
        const domainRange = [
            [520, 500, 700, 150, 200, 10],
            [400, 300, 300, 100, 150, 5]
        ]
        var domainRangeIndex
        switch (app.selectScale) {
            case '全局':
                domainRangeIndex = 0
                break;
            case '局部':
                domainRangeIndex = 1
                break;
            default:
                break;
        }

        switch (target) {
            case 'AQI':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][0]
                colorIndex = 0
                break;
            case 'PM2.5':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][1]
                colorIndex = 1
                break;
            case 'PM10':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][2]
                colorIndex = 2
                break;
            case 'SO2':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][3]
                colorIndex = 3
                break;
            case 'O3':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][4]
                colorIndex = 0
                break;
            case 'CO':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][5]
                colorIndex = 1
                break;
            default:
                break;
        }


        const xValue = d => d.date;
        const yValue = d => d.value;
        
        let xScale, yScale;
        const xBarValue = (datum) => {return datum.date};
        const yBarValue = (datum) => {return datum.value};
        const xAxisLabel = 'date';
        const yAxisLabel = yLabel;
        let transition = d3.transition().duration(2000).ease(d3.easeLinear);

        let gg = d3.select(divid)
        let g = gg.append('g')
        .attr('class', 'plotg')
        .attr('transform', `translate(${-100}, ${0})`);

        var innerHeight = gg.attr('height')
        var innerWidth = gg.attr('width')

        
        xScale = d3.scaleTime()
        .domain(year)
        .range([0, innerWidth-250])
        
        yScale = d3.scaleLinear()
        .domain([0, d3.max(targetDataYear, d => +(d.value))])
        .range([innerHeight-120, 0])
        

        const xAxisMethod = d3.axisBottom(xScale);
        const yAxisMethod = d3.axisLeft(yScale);
        const xAxisGroup = g.append('g').call(xAxisMethod)
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');
        // xAxisGroup.append('text')
        // .attr('font-size', '1em')
        // .attr('y', 60)
        // .attr('x', innerWidth / 2 - 100)
        // .attr('fill', '#504f4f')
        // .text(xAxisLabel)
        // .attr('text-anchor', 'middle') 

        const yAxisGroup = g.append('g').call(yAxisMethod)
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');
        yAxisGroup.append('text')
        .attr('font-size', '1em')
        .attr("font-family", 'Microsoft YaHei') 
        .attr('transform', `rotate(-90)`)
        .attr('x', -(innerHeight - 100) / 2)
        .attr('y', -70)
        .attr('fill', '#504f4f')
        .text(yAxisLabel)
        .attr('text-anchor', 'middle') 

        xAxisGroup.attr('transform', `translate(${200}, ${innerHeight-70})`);
        yAxisGroup.attr('transform', `translate(${200}, ${50})`);

        var dates = [];
        fullyear = year[0].getFullYear();
        if (fullyear == 2014)
        {
            dates = [[new Date(fullyear, 4, 14), new Date(fullyear, 5, 1)]];
            for (let i = 5; i < 11; i++)
                dates.push([new Date(fullyear, i, 1), new Date(fullyear, i+1, 1)]);
            dates.push([new Date(fullyear, 11, 1), new Date(fullyear+1, 0, 1)]);
        }
        else if (fullyear == 2021)
        {
            dates = [
                [new Date(fullyear, 0, 1), new Date(fullyear, 1, 1)],
                [new Date(fullyear, 1, 1), new Date(fullyear, 2, 1)],
                [new Date(fullyear, 2, 1), new Date(fullyear, 3, 1)],
                [new Date(fullyear, 3, 1), new Date(fullyear, 3, 19)]
            ];
        }
        else
        {
            for (let i = 0; i < 11; i++)
                dates.push([new Date(fullyear, i, 1), new Date(fullyear, i+1, 1)]);
            dates.push([new Date(fullyear, 11, 1), new Date(fullyear+1, 0, 1)]);
        }

        const line = d3.line()
            .x(d => { return xScale(xValue(d)) })
            .y(d => { return yScale(+(yValue(d))) })
            .curve(d3.curveCardinal.tension(0.5))

        const lineEmpty = d3.line()
            .x(d => { return xScale(xValue(d)) })
            .y(d => { return yScale(0) })
            .curve(d3.curveCardinal.tension(0.5))

        const pathupdate = g.selectAll('.datacurve').data([targetDataYear])
        const pathenter = pathupdate.enter().append('path')
            .attr('class', 'datacurve')
            .attr('fill', 'none')
            .attr('stroke', mapColors(8-colorIndex))
            .attr('stroke-width', 2)
            .attr('d', lineEmpty)
            .attr('transform', `translate(${200}, ${50})`)
        pathupdate.merge(pathenter)
            .transition(transition)
            .attr('d', line)
        
        const dotupdate = g.selectAll('.dot').data(targetDataYear)
        const dotenter = dotupdate.enter().append('circle')
            .attr("class", "dot") // Assign a class for styling
            .attr("cx", d => xScale(d.date))
            .attr("cy", d => yScale(0))
            .attr("r", 2)
            .attr('transform', `translate(${200}, ${50})`)
            .attr('display', function(d){
                if(d.value == -1.0){
                    return 'none'
                }
                return 'block'
            })
            .attr('fill', mapColors(8-colorIndex))
        dotupdate.merge(dotenter)
            .transition(transition)
            .attr('cy', d => yScale(+(d.value)))

        await transition.end();

        g.selectAll(".highlightarea").data(dates).join('rect')
            .attr('class', 'highlightarea')
            .attr('x', d => xScale(d[0]))
            .attr('y', 0)
            .attr('width', d => xScale(d[1])-xScale(d[0]))
            .attr('height', innerHeight-120)
            .attr('fill', '#DCDCDC')
            .attr('opacity', 0)
            .attr('transform', `translate(${200}, ${50})`)
            .on('mouseover', (event, d) => {
                d3.select(event.currentTarget).attr('opacity', 0.3);
                highlightedMonth = d;
                g.selectAll(".dot").data(targetDataYear)
                .attr('fill', function(d){
                    if (d.date >= highlightedMonth[0] && d.date < highlightedMonth[1])
                        return 'purple';
                    else
                        return mapColors(8-colorIndex);
                })
                var targetDataMonth = [];
                targetDataYear.forEach(datum => { 
                    if (datum.date >= d[0] && datum.date < d[1])
                        targetDataMonth.push(datum);
                })
                g.selectAll('.datacure_h').data([targetDataMonth]).join('path')
                    .attr('class', 'datacurve_h')
                    .attr('fill', 'none')
                    .attr('stroke-width', 2.5)
                    .attr('d', line)
                    .attr('transform', `translate(${200}, ${50})`)
                    .attr('stroke', 'purple')
            })
            .on('mouseout', (event, d) => {
                d3.select(event.currentTarget).attr('opacity', 0);
                hightlightedMonth = [];
                g.selectAll(".dot").data(targetDataYear)
                .attr('fill', function(d){
                    return mapColors(8-colorIndex);
                })
                g.selectAll(".datacurve_h").remove();
            })
            .on('click', (event, d) => {
                var targetDataMonth = [];
                targetDataYear.forEach(datum => { 
                    if (datum.date >= d[0] && datum.date < d[1])
                        targetDataMonth.push(datum);
                })
                g.remove();
                DrawScatterPlotMonth(divid, target, targetDataMonth, d);
                console.log(targetDataMonth);
            });
    }

    function DrawScatterPlotMonth(divid, target, targetDataMonth, months){
        var yLabel
        var scaleDomain
        var colorIndex
        const domainRange = [
            [520, 500, 700, 150, 200, 10],
            [400, 300, 300, 100, 150, 5]
        ]
        var domainRangeIndex
        switch (app.selectScale) {
            case '全局':
                domainRangeIndex = 0
                break;
            case '局部':
                domainRangeIndex = 1
                break;
            default:
                break;
        }

        switch (target) {
            case 'AQI':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][0]
                colorIndex = 0
                break;
            case 'PM2.5':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][1]
                colorIndex = 1
                break;
            case 'PM10':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][2]
                colorIndex = 2
                break;
            case 'SO2':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][3]
                colorIndex = 3
                break;
            case 'O3':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][4]
                colorIndex = 0
                break;
            case 'CO':
                yLabel = target
                scaleDomain = domainRange[domainRangeIndex][5]
                colorIndex = 1
                break;
            default:
                break;
        }


        const xValue = d => d.date;
        const yValue = d => d.value;
        
        let xScale, yScale;
        const xBarValue = (datum) => {return datum.date};
        const yBarValue = (datum) => {return datum.value};
        const xAxisLabel = 'date';
        const yAxisLabel = yLabel;
        let transition = d3.transition().duration(2000).ease(d3.easeLinear);

        let gg = d3.select(divid)
        let g = gg.append('g')
        .attr('class', 'plotg')
        .attr('transform', `translate(${-100}, ${0})`);

        var innerHeight = gg.attr('height')
        var innerWidth = gg.attr('width')

        
        xScale = d3.scaleTime()
        .domain(year)
        .range([0, innerWidth-250])
        
        yScale = d3.scaleLinear()
        .domain([0, d3.max(targetDataYear, d => +(d.value))])
        .range([innerHeight-120, 0])
        

        const xAxisMethod = d3.axisBottom(xScale);
        const yAxisMethod = d3.axisLeft(yScale);
        const xAxisGroup = g.append('g').call(xAxisMethod)
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');
        // xAxisGroup.append('text')
        // .attr('font-size', '1em')
        // .attr('y', 60)
        // .attr('x', innerWidth / 2 - 100)
        // .attr('fill', '#504f4f')
        // .text(xAxisLabel)
        // .attr('text-anchor', 'middle') 

        const yAxisGroup = g.append('g').call(yAxisMethod)
              .attr('font-size', '1.3em')
              .attr('font-weight', 'bold');
        yAxisGroup.append('text')
        .attr('font-size', '1em')
        .attr("font-family", 'Microsoft YaHei') 
        .attr('transform', `rotate(-90)`)
        .attr('x', -(innerHeight - 100) / 2)
        .attr('y', -70)
        .attr('fill', '#504f4f')
        .text(yAxisLabel)
        .attr('text-anchor', 'middle') 

        xAxisGroup.attr('transform', `translate(${200}, ${innerHeight-70})`);
        yAxisGroup.attr('transform', `translate(${200}, ${50})`);

        var dates = [];
        fullyear = year[0].getFullYear();
        if (fullyear == 2014)
        {
            dates = [[new Date(fullyear, 4, 14), new Date(fullyear, 5, 1)]];
            for (let i = 5; i < 11; i++)
                dates.push([new Date(fullyear, i, 1), new Date(fullyear, i+1, 1)]);
            dates.push([new Date(fullyear, 11, 1), new Date(fullyear+1, 0, 1)]);
        }
        else if (fullyear == 2021)
        {
            dates = [
                [new Date(fullyear, 0, 1), new Date(fullyear, 1, 1)],
                [new Date(fullyear, 1, 1), new Date(fullyear, 2, 1)],
                [new Date(fullyear, 2, 1), new Date(fullyear, 3, 1)],
                [new Date(fullyear, 3, 1), new Date(fullyear, 3, 19)]
            ];
        }
        else
        {
            for (let i = 0; i < 11; i++)
                dates.push([new Date(fullyear, i, 1), new Date(fullyear, i+1, 1)]);
            dates.push([new Date(fullyear, 11, 1), new Date(fullyear+1, 0, 1)]);
        }

        const line = d3.line()
            .x(d => { return xScale(xValue(d)) })
            .y(d => { return yScale(+(yValue(d))) })
            .curve(d3.curveCardinal.tension(0.5))

        const lineEmpty = d3.line()
            .x(d => { return xScale(xValue(d)) })
            .y(d => { return yScale(0) })
            .curve(d3.curveCardinal.tension(0.5))

        const pathupdate = g.selectAll('.datacurve').data([targetDataYear])
        const pathenter = pathupdate.enter().append('path')
            .attr('class', 'datacurve')
            .attr('fill', 'none')
            .attr('stroke', mapColors(8-colorIndex))
            .attr('stroke-width', 2)
            .attr('d', lineEmpty)
            .attr('transform', `translate(${200}, ${50})`)
        pathupdate.merge(pathenter)
            .transition(transition)
            .attr('d', line)
        
        const dotupdate = g.selectAll('.dot').data(targetDataYear)
        const dotenter = dotupdate.enter().append('circle')
            .attr("class", "dot") // Assign a class for styling
            .attr("cx", d => xScale(d.date))
            .attr("cy", d => yScale(0))
            .attr("r", 2)
            .attr('transform', `translate(${200}, ${50})`)
            .attr('display', function(d){
                if(d.value == -1.0){
                    return 'none'
                }
                return 'block'
            })
            .attr('fill', mapColors(8-colorIndex))
        dotupdate.merge(dotenter)
            .transition(transition)
            .attr('cy', d => yScale(+(d.value)))

        await transition.end();

        g.selectAll(".highlightarea").data(dates).join('rect')
            .attr('class', 'highlightarea')
            .attr('x', d => xScale(d[0]))
            .attr('y', 0)
            .attr('width', d => xScale(d[1])-xScale(d[0]))
            .attr('height', innerHeight-120)
            .attr('fill', '#DCDCDC')
            .attr('opacity', 0)
            .attr('transform', `translate(${200}, ${50})`)
            .on('mouseover', (event, d) => {
                d3.select(event.currentTarget).attr('opacity', 0.3);
                highlightedMonth = d;
                g.selectAll(".dot").data(targetDataYear)
                .attr('fill', function(d){
                    if (d.date >= highlightedMonth[0] && d.date < highlightedMonth[1])
                        return 'purple';
                    else
                        return mapColors(8-colorIndex);
                })
                var targetDataMonth = [];
                targetDataYear.forEach(datum => { 
                    if (datum.date >= d[0] && datum.date < d[1])
                        targetDataMonth.push(datum);
                })
                g.selectAll('.datacure_h').data([targetDataMonth]).join('path')
                    .attr('class', 'datacurve_h')
                    .attr('fill', 'none')
                    .attr('stroke-width', 2.5)
                    .attr('d', line)
                    .attr('transform', `translate(${200}, ${50})`)
                    .attr('stroke', 'purple')
            })
            .on('mouseout', (event, d) => {
                d3.select(event.currentTarget).attr('opacity', 0);
                hightlightedMonth = [];
                g.selectAll(".dot").data(targetDataYear)
                .attr('fill', function(d){
                    return mapColors(8-colorIndex);
                })
                g.selectAll(".datacurve_h").remove();
            })
            .on('click', (event, d) => {
                var targetDataMonth = [];
                targetDataYear.forEach(datum => { 
                    if (datum.date >= d[0] && datum.date < d[1])
                        targetDataMonth.push(datum);
                })
                console.log(targetDataMonth);
            });
    }

    /**
     * submit the selected date
     * @name SubmitDate
     * @param null
     * @return null
     */
    function SubmitDate() {
        console.log('==============' + 'SubmitDate' + '===================')
        console.log(app.selectYear, app.selectMonth, app.selectDay)

        var validYear = app.selectYear != "" && app.selectYear != undefined
        validMonth = app.selectMonth != "" && app.selectMonth != undefined
        var validDay = app.selectDay != "" && app.selectDay != undefined
        app.queryTime = "xxx"
        
        if(validYear != true){
            app.undefinedDate = true
        }
        else if(validDay == true && validMonth != true){
            app.undefinedDate = true
        }

        if(app.selectYear == 2021 && validMonth == true){
            if(app.selectMonth > 4){
                app.invalidDate = true
                return
            }
            else if(app.selectMonth == 4 && validDay == true){
                if(app.selectDay > 19){
                    app.invalidDate = true
                    return
                }
            }
        }
        else if(app.selectYear == 2014 && validMonth == true){
            if(app.selectMonth < 5){
                app.invalidDate = true
                return
            }
            else if(app.selectMonth == 5 && validDay == true){
                if(app.selectDay < 14){
                    app.invalidDate = true
                    return
                }
            }
        }

        // validate the regular date
        if(validMonth == true){
            if((app.selectMonth == 4 || app.selectMonth == 6 || app.selectMonth == 9 || app.selectMonth == 11) && validDay == true){
                if(app.selectDay > 30){
                    app.invalidDate = true
                    return
                }
            }
            else if(app.selectMonth == 2 && validDay == true){
                if(app.selectYear == 2016 || app.selectYear == 2020){
                    if(app.selectDay > 29){
                        app.invalidDate = true
                        return
                    }
                }
                else{
                    if(app.selectDay > 28){
                        app.invalidDate = true
                        return
                    }
                }
            }
        }

        // generate the time string
        if(validYear == true){
            app.timeRange = 'year'
            app.queryTime = app.selectYear.toString() + "年"
            if(validMonth == true){
                app.timeRange = 'month'
                app.queryTime = app.queryTime + app.selectMonth.toString() + "月"
                if(validDay == true){
                    app.timeRange = 'day'
                    app.queryTime = app.queryTime + app.selectDay.toString() + "日"
                }
            }
        }

        // render the scatter map
        if(validDay == true){
            RenderScatterPlot(app.selectTarget, 'day', app.selectYear, app.selectMonth, app.selectDay)
            myTime = 'day'
        }
        else if(validMonth == true){
            RenderScatterPlot(app.selectTarget, 'month', app.selectYear, app.selectMonth, app.selectDay)
            myTime = 'month'
        }
        else{
            RenderScatterPlot(app.selectTarget, 'year', app.selectYear, app.selectMonth, app.selectDay)
            myTime = 'year'
        }
        myTarget = app.selectTarget
        myYear = app.selectYear
        myMonth = app.selectMonth
        myDay = app.selectDay
    }

    /**
     * change the quality rank best or worse (Histogram)
     * @name ChangeQualityRank
     * @param null
     * @return null
     */
    function ChangeQualityRank() {
        console.log('==============' + 'ChangeQualityRank' + '===================')
        if(app.qualityRank == "AQI最好"){
            console.log('==============' + '最好' + '===================')
            // to do
        }
        else{
            console.log('==============' + '最差' + '===================')
            // to do
        }
    }

    /**
     * change the quality distribution best or worse (Pie chart)
     * @name ChangeQualityDistribution
     * @param null
     * @return null
     */
     function ChangeQualityDistribution() {
        console.log('==============' + 'ChangeQualityDistribution' + '===================')
        if(app.qualityRank == "AQI最好"){
            console.log('==============' + '最好' + '===================')
            // to do
        }
        else{
            console.log('==============' + '最差' + '===================')
            // to do
        }
    }

    /**
     * change the quality region 
     * @name ChangeRegion
     * @param null
     * @return null
     */
     function ChangeRegion() {
        console.log('==============' + 'ChangeRegion' + '===================')
        console.log('当前选择的展示区域是', app.selectRegion)
        // to do
    }
    

  </script>

  <style scoped>
      .timeSelection {
            width:250px;
            margin-left: 20px;
            margin-top: 20px;
      }

      #content1 {
            display: flex;
      }

      #test {
            display: block;
      }

      .cardBox {
            display: inline;
            width: 280px;
      }

      .cardDiv {
            display: flex;
            height: 150px;
      }

      .cardDiv2 {
            display: flex;
            height: 360px;
      }

      .ivu-select {
            margin-bottom: 10px;
      }

      .ivu-btn {
            margin-top: 20px;
            float: right;
      }

      #mapSvg {
          margin-top: 10px;
          margin-right: 10px;
      }

      .plotSelection {
            width:250px;
            margin-left: 20px;
            margin-top: 20px;
      }

      #content2 {
            display: flex;
      }

      .plotSvg {
            width: 1100px;
            height: 300px;
      }

      .rankSelection{
            width:250px;
            margin-left: 20px;
            margin-top: 20px;
      }

      .regionSelection{
            width:250px;
            margin-left: 20px;
            margin-top: 20px;
      }

      .distributionSelection{
            width:250px;
            margin-left: 20px;
            margin-top: 20px;
      }

      p {
            font-family: "Microsoft YaHei";
            font-size: 15px;
      }

      .ivu-menu-item {
        font-size: 17px;
      }

      div, li, label, button, .ivu-radio-wrapper{
            /* font-family: "华文细黑"; */
            font-family: "Microsoft YaHei";
            font-size: 15px;
      }

      /* .scatterText {
            font-family: "Microsoft YaHei";
      } */

      i {
            font-family: "Microsoft YaHei";
            font-size: 20px;
      }

      .title {
        font-family: "Microsoft YaHei";
        font-size: 12px;
      }
  </style>

</body>
</html>