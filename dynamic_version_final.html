<!DOCTYPE html>
<html>

<head>
  <title>Assignment1</title>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <link rel="stylesheet" type="text/css" href="http://unpkg.com/iview/dist/styles/iview.css">
  <script src="d3.min.js"></script>
  <script type="text/javascript" src="http://unpkg.com/iview/dist/iview.min.js"></script>
</head>

<body>

  <svg width="1600" height="800" id="mainsvg" class="svgs"></svg>
  <script>
      const svg = d3.select('svg');
      const width = svg.attr('width');
      const height = svg.attr('height');
      const margin = {top: 60, right: 30, bottom: 60, left: 150};
      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;
      const mainGroup = svg.append('g')
      .attr('transform', `translate(${margin.left}, ${margin.top})`)
      .attr('id', 'maingroup');
      // console.log(d);
      const xValue = d => d.globalsale;
      const yValue = d => d.platform;

      
      let xSacle, yScale;
      const xBarValue = (datum) => {return datum.globalsale};
      const yBarValue = (datum) => {return datum.platform};
      const xAxisLabel = 'GlobalSale';
      const yAxisLabel = 'Platform';
      
      let totalduration = 20000;
      let aduration = 800;

      const platforms = ["Wii", "NES", "GB", "DS", "X360", "PS3", "PS2", "SNES", "GBA", "3DS", "PS4", "N64", "PS", "XB", "PC", "2600", "PSP", "XOne", "GC", "WiiU", "GEN", "DC", "PSV", "SAT", "SCD", "WS", "NG", "TG16", "3DO", "GG", "PCFX"];

      const colors = {
        'Wii':"#DD6B66", 
        'NES':"#759AA0", 
        'GB':"#E69D87", 
        'DS':"#8DC1A9",
        'X360':"#EA7E53", 
        'PS3':"#EEDD78", 
        'PS2':"#73A373",
        'SNES':"#73B9BC",
        'GBA':"#7289AB", 
        '3DS':"#91CA8C", 
        'PS4':"#F49F42", 
        'N64':"#AA312C",
        'PS':"#39656D",
        'XB':"#B35E45", 
        'PC':"#4B8E6F", 
        '2600 ':"#B6481C",
        'PSP':"#BBA838", 
        'XOne':"#386F38", 
        'GC':"#388589", 
        'WiiU':"#385177",
        'GEN':"#50964A", 
        'DC':"#C16B0D", 
        'PSV':"#FF8500", 
        'SAT':"#45BFD3",
        'SCD':"#FF5F2F", 
        'WS':"#50F3A8", 
        'NG':"#FF4800", 
        'TG16':"#FFDE1A",
        '3DO':"#41D541", 
        'GG':"#32E7EF", 
        'PCFX':"#ef638e",
        '2600':"#B6481C",
      };

      const renderinit = function(){
        let g = d3.select('#maingroup');

        xScale = d3.scaleLinear()
        .domain([0, 1300])
        .range([0, innerWidth-100]);
        yScale = d3.scaleBand()
        .domain(platforms)
        .range([0, innerHeight-20])
        .padding(0.01);

        const xAxisMethod = d3.axisBottom(xScale);
        const yAxisMethod = d3.axisLeft(yScale);

        const xAxisGroup = mainGroup.append('g').call(xAxisMethod)
              .attr("class","x-axis")
              .attr('font-size', '1.2em')
              // .attr('font-weight', 'bold');
        xAxisGroup.append('text')
        .attr('font-size', '2em')
        .attr('y', 60)
        .attr('x', innerWidth / 2)
        .attr('fill', '#504f4f')
        .text(xAxisLabel);

        const yAxisGroup = mainGroup.append('g').call(yAxisMethod)
              .attr("class","y-axis")
              .attr('font-size', '1.2em')
              // .attr('font-weight', 'bold');
        yAxisGroup.append('text')
        .attr('font-size', '2em')
        .attr('transform', `rotate(-90)`)
        .attr('x', -(innerHeight - 20) / 2)
        .attr('y', -70)
        .attr('fill', '#504f4f')
        .text(yAxisLabel)
        .attr('text-anchor', 'middle') 
        .text(yAxisLabel);
        xAxisGroup.attr('transform', `translate(${0}, ${innerHeight-20})`);

        let legend_color = Object.values(colors);
        let legend_text = Object.keys(colors);
        // draw legend
        var legend = d3.select('#maingroup').selectAll(".legend")
        .data(legend_text).join('g')
        .attr("class", "legend")
        .attr("transform", function(d, i) { return "translate(" + (innerWidth - 50) + "," + ((i-1) * 22) + ")"; });
  
        // draw legend colored rectangles
        legend.append("rect")
        .data(legend_color) 
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", 30)
        .attr("height", 20)
        .style("fill", d => d);
  
        // draw legend text
        legend.append("text")
        .attr("x", 40)
        .attr("y", 9)
        .attr("dy", ".5em")
        .attr("text-anchor", "start")
        .attr("fill", "#504f4f")
        .text(d => d); 

        d3.select(".legend").remove();

        g.append("text")
        .attr('id', 'date_text')
        .attr("x", innerWidth - 120)
        .attr("y", innerHeight - 80)
        .attr("dy", ".5em")
        .style("text-anchor", "end")
        .attr("fill", "#504f4f")
        .attr('font-size', '5em')
        .attr('font-weight', 'bold')
        .text(' ');
      }

      /* 
        Loading data and preprocessing data. 
        Note that you can also preprocessing data in your own way using your prefered language, e.g., Python. 
      */

      d3.csv('pgy.csv').then(data =>{
        // process data
        var sales = {};
        var platforms = [];
        for (var i = 0; i < data.length; i++){

          var year = parseInt(data[i]['year']);
          var platform = data[i]['platform'];
          var globalsale = data[i]['globalsale'];

          if (platforms.indexOf(platform) === -1){
            platforms.push(platform);
          }

          if(sales[year] !== undefined){
            sales[year][platform] = globalsale;
          }
          else{
            sales[year] = {};
            sales[year][platform] = globalsale;
          }
        }

        renderinit();

        // set the animation interval; 
        var gamesales = []
        
        let c = 1980; 
        let intervalId = setInterval(function(){
            if(c >= 2021){
                console.log('time to close this animation');
                clearInterval(intervalId); 
            }else{
              const transition = d3.transition().duration(aduration).ease(d3.easeLinear);
              console.log('year', c);

              gamesales = gamesales.sort(function(a, b){return parseFloat(b.globalsale) - parseFloat(a.globalsale)});

              var tmpgamesales = [];
              for (var i = 0; i < gamesales.length; i++){
                tmpgamesales.push({
                  'platform':gamesales[i]['platform'],
                  'globalsale':gamesales[i]['globalsale']
                });
              }
              for (var key in sales[String(c)]){
                var tmp = tmpgamesales.find(item => item.platform == key);
                if (tmp !== undefined){
                  tmp['globalsale'] = parseFloat(sales[String(c)][key]);
                }
                else{
                  tmpgamesales.push({
                    'platform':key,
                    'globalsale':parseFloat(sales[String(c)][key])
                  });
                }

                gamesales = [];
                for (var i = 0; i < tmpgamesales.length; i++){
                  gamesales.push({
                    'platform':tmpgamesales[i]['platform'],
                    'globalsale':tmpgamesales[i]['globalsale']
                  });
                }
              }

              let g = d3.select('#maingroup');

              xScale = d3.scaleLinear()
              .domain([0, d3.max(gamesales, d => d.globalsale)+50])
              .range([0, innerWidth-80]);

              d3.select("g.x-axis")
              .transition(transition)
              .call(d3.axisBottom(xScale));

              d3.selectAll("g.x-axis g.tick")
              .select("line.grid-line")
              .remove();

              let xlines = d3.selectAll("g.x-axis g.tick")
              .append("line")
              .classed("grid-line",true);
              xlines.attr("x1",0)
              .attr("y1",0)
              .attr("x2",0)
              .attr("y2",-innerHeight);


              var tmpPlatforms = [];
              for (var i = 0; i < gamesales.length; i++){
                tmpPlatforms.push(gamesales[i]['platform']);
              }

              yScale = d3.scaleBand()
              .domain(tmpPlatforms)
              .range([0, innerHeight-20])
              .padding(0.01);
              
              d3.select("g.y-axis")
              .transition(transition)
              .call(d3.axisLeft(yScale));

              d3.selectAll("g.y-axis g.tick")
              .select("line.grid-line")
              .remove();

              let ylines = d3.selectAll("g.y-axis g.tick")
              .append("line")
              .classed("grid-line",true);

              ylines.attr("x1",0)
              .attr("y1",0)
              .attr("x2", innerWidth)
              .attr("y2",0);


              d3.select('#date_text').text(String(c)+'年');

              
              g.selectAll('.rect-barchart')
              .data(gamesales, data => data.platform)
              .join('rect')
              .transition(transition)
              .attr('id', function(d){
                return d.platform;
              })
              .attr('value', function(d){
                return d.globalsale;
              })
              .attr('class', 'rect-barchart')
              .attr('fill', function(datum){return colors[datum.platform]})
              .attr("rx", 5)
              .attr('x', 0)
              .attr('height', yScale.bandwidth() * 4 / 5)
              .attr('width', (datum) => {return xScale(xBarValue(datum))})
              .attr("y", function(d, i) { //对排序之后的横坐标重排
                  return yScale(tmpPlatforms[i]) + yScale.bandwidth() / 10 ;
              });

              const textbarchart = g.selectAll('.text-barchart').data(gamesales, data => data.platform);
              textbarchart.enter().append('text')
              .attr('class', 'text-barchart')
              .attr('y', datum => yScale(yBarValue(datum)) + yScale.bandwidth() / 2)
              .attr('x', (datum) => {return xScale(xBarValue(datum))})
              .attr('dx', 10)
              .attr('text-anchor', 'start')
              .attr("fill", "#504f4f")
              .attr('font-size', '1.2em')
              .attr('font-weight', 'bold');

              textbarchart.text(d => d.globalsale)
              .transition(transition)
              .tween('text', function(d) {
                var i = d3.interpolate(this.textContent, d.globalsale);
                return function(t){
                    this.textContent = d3.format('.2f')(i(t));
                }
              })
              .attr('x', (datum) => {
                  return xScale(xBarValue(datum));
              })
              .attr("y", function(d, i) { //对排序之后的横坐标重排
                  return yScale(tmpPlatforms[i]) + yScale.bandwidth()/2 + 5;
              });
              
              c = c + 1;
            }
        }, aduration); 
        
      })
  </script> 
</body>

</html>
